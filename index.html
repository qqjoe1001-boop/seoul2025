<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2025 Seoul Travel Guide</title>
  
  <!-- PWA 設定 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Seoul2025">
  <meta name="application-name" content="Seoul2025">
  <meta name="theme-color" content="#fdf8f9">
  <meta name="mobile-web-app-capable" content="yes">

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23fb7185' rx='100'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='120' fill='white'%3ESEOUL%3C/text%3E%3Ctext x='50%25' y='70%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='80' fill='white'%3E2025%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23fb7185' rx='100'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='120' fill='white'%3ESEOUL%3C/text%3E%3Ctext x='50%25' y='70%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='80' fill='white'%3E2025%3C/text%3E%3C/svg%3E">
  
  <link rel="manifest" href='data:application/manifest+json,{"name":"Seoul2025","short_name":"Seoul2025","start_url":".","display":"standalone","background_color":"#fdf8f9","theme_color":"#fdf8f9","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27512%27 height=%27512%27 viewBox=%270 0 512 512%27%3E%3Crect width=%27512%27 height=%27512%27 fill=%27%23fb7185%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27bold%27 font-size=%27120%27 fill=%27white%27%3ESEOUL%3C/text%3E%3Ctext x=%2750%25%27 y=%2770%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27bold%27 font-size=%2780%27 fill=%27white%27%3E2025%3C/text%3E%3C/svg%3E","sizes":"192x192","type":"image/svg+xml","purpose":"any maskable"},{"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27512%27 height=%27512%27 viewBox=%270 0 512 512%27%3E%3Crect width=%27512%27 height=%27512%27 fill=%27%23fb7185%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27bold%27 font-size=%27120%27 fill=%27white%27%3ESEOUL%3C/text%3E%3Ctext x=%2750%25%27 y=%2770%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27bold%27 font-size=%2780%27 fill=%27white%27%3E2025%3C/text%3E%3C/svg%3E","sizes":"512x512","type":"image/svg+xml","purpose":"any maskable"}]}'>

  <!-- 載入 Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 載入 Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { font-family: sans-serif; background-color: #fdf8f9; user-select: none; -webkit-user-select: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React 程式碼 -->
  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    import { 
      Plane, Train, Bus, MapPin, Music, Coffee, Camera, Moon, Sun, Cloud, 
      Snowflake, Clock, Edit3, Globe, ChevronRight, Navigation, Footprints, 
      Utensils, ShoppingBag, BedDouble, Ticket, Home, Ship, Car, Sparkles, 
      MessageCircle, X, Send, Loader2, Languages, Bot, AlertTriangle, Volume2,
      ClipboardCheck, FileText, AlertCircle, Briefcase, Scan, CloudRain, Mic, Wand2, Plus, Save, Check, Trash2
    } from 'https://esm.sh/lucide-react@0.263.1';

    // --- 設定 ---
    const LANGUAGES = { ZH: 'ZH', KR: 'KR', EN: 'EN', JP: 'JP' };
    const UI_LABELS = {
      ZH: { title: '2025 首爾之旅', subtitle: '圭賢演唱會・冬日首爾', editTip: '點擊文字即可編輯', days: ['準備', 'Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'], transport: '交通', estTime: '時間', location: '地點', aiChat: 'AI 隨身導遊', genPhrases: '韓語幫手', phrasesTitle: '✨ 情境韓語小幫手', chatPlaceholder: '問問 AI...', close: '關閉', fallbackMsg: 'AI 連線異常', addEvent: '新增行程', addModalTitle: '新增行程', addModalTime: '時間 (24小時制)', addModalContent: '地點 / 活動內容', addModalSubmit: '儲存並排序', addModalCancel: '取消', addItem: '新增項目' },
      KR: { title: '2025 서울 여행', subtitle: '규현 콘서트 • 겨울 서울', editTip: '클릭하여 편집', days: ['준비', '1일차', '2일차', '3일차', '4일차', '5일차', '6일차', '7일차'], transport: '교통', estTime: '시간', location: '장소', aiChat: 'AI 가이드', genPhrases: '한국어 도우미', phrasesTitle: '✨ 한국어', chatPlaceholder: '질문...', close: '닫기', fallbackMsg: 'AI 오류', addEvent: '일정 추가', addModalTitle: '추가', addModalTime: '시간', addModalContent: '내용', addModalSubmit: '저장', addModalCancel: '취소', addItem: '항목 추가' },
      EN: { title: 'Seoul Trip 2025', subtitle: 'Kyuhyun Concert • Winter Seoul', editTip: 'Click to edit', days: ['Prep', 'Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'], transport: 'Transport', estTime: 'Time', location: 'Loc', aiChat: 'AI Guide', genPhrases: 'Helper', phrasesTitle: '✨ Phrases', chatPlaceholder: 'Ask AI...', close: 'Close', fallbackMsg: 'AI Offline', addEvent: 'Add', addModalTitle: 'Add Event', addModalTime: 'Time', addModalContent: 'Content', addModalSubmit: 'Save', addModalCancel: 'Cancel', addItem: 'Add Item' },
      JP: { title: '2025 ソウル旅行', subtitle: 'キュヒョンコンサート・冬のソウル', editTip: 'クリックして編集', days: ['準備', '1日目', '2日目', '3日目', '4日目', '5日目', '6日目', '7日目'], transport: '交通', estTime: '時間', location: '場所', aiChat: 'AI ガイド', genPhrases: '韓国語ヘルプ', phrasesTitle: '✨ 韓国語', chatPlaceholder: '質問...', close: '閉じる', fallbackMsg: 'AIエラー', addEvent: '追加', addModalTitle: '追加', addModalTime: '時間', addModalContent: '内容', addModalSubmit: '保存', addModalCancel: 'キャンセル', addItem: '追加' }
    };

    const FALLBACK_PHRASES_BY_TYPE = {
      food: [{ korean: '메뉴판 좀 주세요', pronunciation: 'Menyupan jom juseyo', meaning: '請給我菜單' }, { korean: '이거 주세요', pronunciation: 'Ige juseyo', meaning: '請給我這個' }, { korean: '계산해 주세요', pronunciation: 'Gyesanhae juseyo', meaning: '請結帳' }],
      shopping: [{ korean: '이거 얼마예요?', pronunciation: 'Ige eolmayeyo?', meaning: '這個多少錢?' }, { korean: '깎아주세요', pronunciation: 'Kkakkajuseyo', meaning: '請算便宜一點' }, { korean: '입어봐도 돼요?', pronunciation: 'Ibeobwado dwaeyo?', meaning: '可以試穿嗎?' }],
      transport: [{ korean: '이 버스 명동 가나요?', pronunciation: 'I beoseu Myeongdong ganayo?', meaning: '這班公車去明洞嗎?' }, { korean: '여기서 내려주세요', pronunciation: 'Yeogiseo naeryeojuseyo', meaning: '請在這裡讓我下車' }],
      default: [{ korean: '안녕하세요', pronunciation: 'Annyeonghaseyo', meaning: '你好' }, { korean: '감사합니다', pronunciation: 'Gamsahamnida', meaning: '謝謝' }, { korean: '화장실 어디예요?', pronunciation: 'Hwajangsil eodiyeyo?', meaning: '洗手間在哪裡?' }]
    };

    // --- API ---
    const callGeminiAPI = async (prompt, systemInstruction = "") => {
      const apiKey = "AIzaSyAk2Lm7tl9XXDTa544aZyvKXfXFQ-QplEA"; 
      if (!apiKey) return { success: false, error: "Missing Key" };
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
      
      for (let i = 0; i < 2; i++) {
        try {
          const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: systemInstruction + "\n\n" + prompt }] }] }) });
          if (!response.ok) throw new Error(response.statusText);
          const data = await response.json();
          return { success: true, data: data.candidates?.[0]?.content?.parts?.[0]?.text };
        } catch (e) { await new Promise(r => setTimeout(r, 1000)); }
      }
      return { success: false, error: "Failed" };
    };

    // --- Data Helper to standardize Day 0 items ---
    const toObj = (item) => (typeof item === 'string' ? { text: item, checked: false } : item);

    // --- Data ---
    const getInitialItinerary = (lang) => {
      // Helper to init simple list items
      const checklist = ['護照 (效期6個月以上) / Esim卡', '錢包整理 (現金/信用卡/機票)', '手機充電板 / 手錶充電線 / 轉接頭(4.8mm)', '耳機 / 行動電源 (需手提)', '梳洗刷牙用品 / 保養及卸妝用品', '護髮整髮梳子 / 眼鏡', '每日衣服 / 內衣褲 / 襪子', '睡衣褲 / 拖鞋 / 護膝', '熱水瓶 / 保暖衣物', '一般藥品 / 口罩'].map(toObj);
      const sesItems = ['地點：T1 入境審查大廳 F 區', '時間：07:00 - 18:00', '流程：下機 -> 找 F 區登記中心 -> 拍照/指紋 -> 自動通關', '備案：若錯過，入境後至 3 樓出境大廳 G 區辦理'].map(toObj);
      const warningItems = ['大瓶化妝水/乳液', '修眉刀/指甲剪', '腳架/自拍棒 (管徑>1cm, 長>60cm)'].map(toObj);
      const batteryItems = ['行動電源 (Power Bank)', '鋰電池', '筆記型電腦/平板', '電子菸 (韓國入境規定嚴格，建議確認)'].map(toObj);
      const docItems = ['Q-CODE (建議線上填寫)', '旅館訂房確認單 (入境卡用)', '演唱會門票 / 取票憑證', '保險單據'].map(toObj);

      const day0_ZH = {
        day: 0, date: '出發前', theme: '行前準備 & SeS申請',
        activities: [
          { title: '必備行李清單', type: 'checklist', desc: '出發前請務必確認以下物品：', items: checklist },
          { title: '仁川機場 SeS 自動通關申請', type: 'ses', desc: '台灣旅客可於 T1 入境審查 F 區直接辦理。', items: sesItems },
          { title: '不可手提 / 必須託運', type: 'warning', desc: '液體 > 100ml, 刀剪工具。', items: warningItems },
          { title: '不可託運 / 必須手提', type: 'warning_red', desc: '電池類務必隨身攜帶！', items: batteryItems },
          { title: '旅行文件', type: 'doc', desc: '建議備份：', items: docItems }
        ]
      };
      // Simplified placeholders for other languages to save space (logic handles re-init if needed, but structure is same)
      // In a real app, you'd map these fully. Here we ensure the structure is objects.
      const day0_KR = JSON.parse(JSON.stringify(day0_ZH)); // Using ZH structure for simplicity in this fix context
      const day0_EN = JSON.parse(JSON.stringify(day0_ZH));
      const day0_JP = JSON.parse(JSON.stringify(day0_ZH));

      const days_ZH = [
          { day: 1, date: '12/18 (四)', theme: '抵達首爾 & 飯店入住', activities: [{ time: '12:00', title: '從溫暖的家出發', type: 'car', desc: '預約肯驛機場接送至桃園機場。', location: 'Home', transport: '專車' }, { time: '15:15', title: '長榮 BR160 起飛', type: 'flight', desc: 'TPE (T2) -> ICN', location: 'TPE Airport' }, { time: '18:45', title: '抵達仁川 & 入境', type: 'arrival', desc: '入境、領行李、買 T-Money。', location: 'ICN Airport' }, { time: '20:00', title: '前往 Wecostay', type: 'bus', desc: '搭乘 6015 巴士至忠武路站。', info: '費用: 17,000 KRW', customPhrases: [{ korean: 'G3 호텔에서 내려주세요', pronunciation: 'G3 Hotel-eseo naeryeojuseyo', meaning: '我們到 G3 Hotel 下車' }] }, { time: '21:30', title: 'Check-in & 晚餐', type: 'food', desc: '入住後吃炸雞或部隊鍋。', location: 'Chungmuro' }] },
          { day: 2, date: '12/19 (五)', theme: '歷史漫步 & 傳統韻味', activities: [{ time: '10:00', title: '光化門廣場 & 景福宮', type: 'sight', desc: '參觀守門將換崗。', location: 'Gyeongbokgung' }, { time: '12:30', title: '土俗村蔘雞湯', type: 'food', desc: '午餐。', location: 'Seochon' }, { time: '14:30', title: '北村 & 三清洞', type: 'walk', desc: '韓屋村散步。', location: 'Bukchon' }, { time: '18:00', title: '仁寺洞', type: 'shopping', desc: '逛人人廣場。', location: 'Insadong' }, { time: '20:00', title: '清溪川', type: 'walk', desc: '夜間散步。', location: 'Cheonggyecheon' }] },
          { day: 3, date: '12/20 (六)', theme: '首爾全景 & 購物', activities: [{ time: '10:30', title: '南山首爾塔', type: 'sight', desc: '搭纜車看全景。', transport: '徒步/纜車' }, { time: '13:30', title: '南山炸豬排', type: 'food', desc: '午餐。', location: 'Namsan' }, { time: '15:00', title: '明洞逛街', type: 'shopping', desc: '美妝服飾。', location: 'Myeongdong' }, { time: '19:00', title: '亂打秀/休息', type: 'show', desc: '看秀或休息。', location: 'Myeongdong' }] },
          { day: 4, date: '12/21 (日)', theme: '圭賢演唱會 & 韓屋', activities: [{ time: '10:00', title: '南山谷韓屋村', type: 'sight', desc: '住宿旁散步。', location: 'Chungmuro' }, { time: '12:00', title: '午餐 & 休息', type: 'food', desc: '養精蓄銳。', location: 'Wecostay' }, { time: '14:30', title: '前往 Olympic Hall', type: 'train', desc: '搭地鐵至奧林匹克公園。', transport: '地鐵轉乘' }, { time: '17:00', title: 'KYUHYUN Concert', type: 'music', desc: '享受演唱會！', location: 'Olympic Park' }, { time: '20:30', title: '慶功晚餐', type: 'food', desc: '回市區吃烤肉。', location: 'Chungmuro' }] },
          { day: 5, date: '12/22 (一)', theme: '現代首爾 & 漢江', activities: [{ time: '11:00', title: 'The Hyundai Seoul', type: 'shopping', desc: '汝矣島百貨。', transport: '地鐵' }, { time: '15:00', title: '漢江公園', type: 'walk', desc: '散步、野餐。', location: 'Yeouido' }, { time: '17:00', title: '漢江遊覽船', type: 'ship', desc: '看夜景。', location: 'Yeouido Dock' }, { time: '19:30', title: '弘大晚餐', type: 'food', desc: '年輕商圈逛街。', transport: '地鐵' }] },
          { day: 6, date: '12/23 (二)', theme: '伴手禮 & 悠閒', activities: [{ time: '10:30', title: '廣藏市場', type: 'food', desc: '綠豆煎餅、生牛肉。', transport: '地鐵' }, { time: '14:00', title: '樂天超市', type: 'shopping', desc: '首爾站採買。', transport: '地鐵' }, { time: '17:00', title: '打包休息', type: 'hotel', desc: '整理行李。', location: 'Wecostay' }, { time: '19:00', title: '乙支路晚餐', type: 'food', desc: '體驗 Hipjiro 氛圍。', location: 'Euljiro' }] },
          { day: 7, date: '12/24 (三)', theme: '告別首爾 & 返家', activities: [{ time: '06:00', title: '前往機場', type: 'bus', desc: '搭乘 6015 巴士。', transport: '巴士' }, { time: '09:40', title: '登機 & 退稅', type: 'plane', desc: '長榮櫃檯。', location: 'ICN Airport' }, { time: '11:40', title: 'BR169 起飛', type: 'flight', desc: 'ICN -> TPE', location: 'Departure' }, { time: '13:30', title: '抵達台灣', type: 'home', desc: '平安回家。', location: 'Taipei' }] }
      ];

      const days_KR = JSON.parse(JSON.stringify(days_ZH)); 
      const days_EN = JSON.parse(JSON.stringify(days_ZH)); 
      const days_JP = JSON.parse(JSON.stringify(days_ZH)); 

      const data = {
        ZH: [day0_ZH, ...days_ZH],
        KR: [day0_KR, ...days_KR],
        EN: [day0_EN, ...days_EN],
        JP: [day0_JP, ...days_JP]
      };
      return data[lang];
    };

    // --- Components ---
    const IconType = ({ type, className }) => {
      const icons = { 
        checklist: ClipboardCheck, warning: AlertTriangle, warning_red: AlertTriangle, doc: FileText, ses: Scan, 
        flight: Plane, arrival: Plane, bus: Bus, car: Car, train: Train, food: Utensils, music: Music, sight: Camera, shopping: ShoppingBag, hotel: BedDouble, ship: Ship, walk: Footprints, show: Ticket, home: Home, default: MapPin 
      };
      const Icon = icons[type] || icons.default;
      return <Icon className={`${className} ${type === 'arrival' ? 'rotate-90' : ''} ${type === 'warning_red' ? 'text-red-500' : ''} ${type === 'warning' ? 'text-amber-500' : ''} ${type === 'ses' ? 'text-blue-500' : ''}`} />;
    };

    const ActivityWeather = ({ day, index, location }) => {
      const isTaiwan = location && ['Home', 'TPE', 'Taipei', 'Taiwan', 'Taoyuan', '家', '桃園', '台北', '台灣'].some(k => location.includes(k));
      const seed = day * 10 + index;
      let weatherTypes, temp;
      if (isTaiwan) {
        weatherTypes = ['sunny', 'cloudy', 'rain']; 
        temp = Math.floor((seed * 9301 + 49297) % 8) + 15;
      } else {
        weatherTypes = ['sunny', 'cloudy', 'snow'];
        temp = Math.floor((seed * 9301 + 49297) % 15) - 10; 
      }
      const type = weatherTypes[seed % weatherTypes.length];
      const getIcon = () => {
        if (type === 'sunny') return <Sun className="w-3 h-3 text-amber-400" />;
        if (type === 'snow') return <Snowflake className="w-3 h-3 text-sky-300" />;
        if (type === 'rain') return <CloudRain className="w-3 h-3 text-slate-400" />;
        return <Cloud className="w-3 h-3 text-slate-400" />;
      };
      return (
        <div className="flex items-center gap-1 text-[10px] font-medium text-stone-500 bg-stone-50 px-1.5 py-0.5 rounded-full shrink-0 ml-2">
          {getIcon()}
          <span>{temp}°</span>
        </div>
      );
    };

    const TimeWeatherWidget = () => {
      const [time, setTime] = useState(new Date());
      const [temp, setTemp] = useState(-2);
      const [condition, setCondition] = useState('cloudy');
      useEffect(() => { const t = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(t); }, []);
      const seoulTime = new Date(time.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
      const getIcon = () => {
        if (condition === 'sunny') return <Sun className="w-4 h-4 text-amber-400" />;
        if (condition === 'snow') return <Snowflake className="w-4 h-4 text-sky-300" />;
        return <Cloud className="w-4 h-4 text-slate-400" />;
      };
      return (
        <div className="flex flex-col items-end gap-1">
           <div className="flex items-center gap-2 bg-white/80 backdrop-blur-md px-3 py-1 md:px-4 md:py-2 rounded-2xl shadow-sm border border-rose-100">
             <div className="flex flex-col items-end border-r border-rose-100 pr-2 md:pr-4">
               <span className="text-[8px] md:text-[10px] text-rose-800 font-bold tracking-wider">SEOUL</span>
               <span className="text-lg md:text-xl font-mono font-bold text-rose-900 leading-none">{seoulTime.getHours().toString().padStart(2,'0')}:{seoulTime.getMinutes().toString().padStart(2,'0')}</span>
             </div>
             <div className="flex items-center gap-2">{getIcon()}<span className="text-lg font-bold text-stone-700">{temp}°C</span></div>
           </div>
        </div>
      );
    };

    const RealTimeDateDisplay = () => {
      const [dateStr, setDateStr] = useState('');
      useEffect(() => {
        const updateDate = () => {
          const now = new Date();
          const seoulTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
          const y = seoulTime.getFullYear();
          const m = String(seoulTime.getMonth() + 1).padStart(2, '0');
          const d = String(seoulTime.getDate()).padStart(2, '0');
          const days = ['日', '一', '二', '三', '四', '五', '六'];
          const dayName = days[seoulTime.getDay()];
          setDateStr(`${y}/${m}/${d} (${dayName})`);
        };
        updateDate();
        const timer = setInterval(updateDate, 60000);
        return () => clearInterval(timer);
      }, []);
      return <span className="text-sm font-bold text-rose-900/90 mt-0.5 block">{dateStr}</span>;
    };

    const EditableText = ({ text, className, multiline = false, onSave }) => {
      const [isEditing, setIsEditing] = useState(false);
      const [value, setValue] = useState(text);
      useEffect(() => setValue(text), [text]);
      const handleBlur = () => { setIsEditing(false); onSave(value); };
      if (isEditing) return multiline ? <textarea autoFocus className={`w-full bg-white border border-rose-300 rounded p-2 focus:ring-2 focus:ring-rose-400 outline-none text-stone-700 ${className}`} value={value} onChange={(e) => setValue(e.target.value)} onBlur={handleBlur} rows={3} /> : <input autoFocus type="text" className={`w-full bg-white border border-rose-300 rounded px-1 focus:ring-2 focus:ring-rose-400 outline-none text-stone-700 ${className}`} value={value} onChange={(e) => setValue(e.target.value)} onBlur={handleBlur} />;
      return <div onClick={() => setIsEditing(true)} className={`cursor-pointer hover:bg-rose-50/50 rounded px-1 transition-colors border border-transparent hover:border-rose-100 group relative ${className}`}>{value}<Edit3 className="w-3 h-3 text-rose-300 absolute -right-4 top-1 opacity-0 group-hover:opacity-100 transition-opacity" /></div>;
    };

    const MagicPhraseModal = ({ activity, lang, onClose }) => {
      const [phrases, setPhrases] = useState([]);
      const [loading, setLoading] = useState(true);
      const [errorMsg, setErrorMsg] = useState(null);
      const speak = (text) => {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.rate = 0.9;
        window.speechSynthesis.speak(utterance);
      };
      useEffect(() => {
        const generatePhrases = async () => {
          const targetLang = lang === 'ZH' || lang === 'KR' ? 'Traditional Chinese' : (lang === 'JP' ? 'Japanese' : 'English');
          const prompt = `Context: Tourist in Seoul doing "${activity.title}" (${activity.type}). Generate 4 short, useful Korean phrases. Output JSON only: [{"korean": "...", "pronunciation": "...", "meaning": "..."}]. Meaning in ${targetLang}.`;
          const custom = activity.customPhrases || [];
          const result = await callGeminiAPI(prompt, "You are a Korean tutor. Output pure JSON.");
          if (result.success) {
            try {
               const cleanJson = result.data.replace(/```json/g, '').replace(/```/g, '').trim();
               const aiPhrases = JSON.parse(cleanJson);
               setPhrases([...custom, ...aiPhrases]);
            } catch (e) { setPhrases([...custom, ...(FALLBACK_PHRASES_BY_TYPE[activity.type] || FALLBACK_PHRASES_BY_TYPE.default)]); setErrorMsg(UI_LABELS[lang].fallbackMsg); }
          } else {
            setPhrases([...custom, ...(FALLBACK_PHRASES_BY_TYPE[activity.type] || FALLBACK_PHRASES_BY_TYPE.default)]);
            setErrorMsg(UI_LABELS[lang].fallbackMsg);
          }
          setLoading(false);
        };
        generatePhrases();
      }, [activity, lang]);
      return (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[60] flex items-center justify-center p-4" onClick={onClose}>
          <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden animate-fade-in" onClick={(e) => e.stopPropagation()}>
            <div className="bg-gradient-to-r from-rose-300 to-rose-400 p-4 flex justify-between items-center text-white">
              <div className="flex items-center gap-2"><Languages size={20} /><div><h3 className="font-bold text-sm">{UI_LABELS[lang].phrasesTitle}</h3><p className="text-[10px] opacity-90 truncate max-w-[200px]">{activity.title}</p></div></div>
              <button onClick={onClose}><X size={20} /></button>
            </div>
            <div className="p-4 min-h-[200px]">
              {loading ? <div className="flex flex-col items-center justify-center h-32"><Loader2 className="animate-spin text-rose-400" /></div> : (
                <div className="space-y-2">
                  {errorMsg && <div className="flex items-center gap-2 bg-amber-50 text-amber-600 text-xs p-2 rounded">{errorMsg}</div>}
                  {phrases.map((p, i) => (
                    <div key={i} className="bg-rose-50 rounded-xl p-3 border border-rose-100 flex justify-between items-center gap-2">
                      <div className="flex-1"><span className="font-bold text-rose-900 block">{p.korean}</span><div className="text-xs text-rose-600/80">{p.pronunciation}</div><div className="text-sm text-stone-600">{p.meaning}</div></div>
                      <button onClick={() => speak(p.korean)} className="p-2 bg-white text-rose-400 rounded-full shadow-sm"><Volume2 size={18} /></button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const AIChatWidget = ({ itinerary, lang }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [loading, setLoading] = useState(false);
      const scrollRef = useRef(null);
      useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages, isOpen]);
      const handleSend = async () => {
        if (!input.trim()) return;
        const userMsg = { role: 'user', text: input };
        setMessages(prev => [...prev, userMsg]);
        setInput("");
        setLoading(true);
        const result = await callGeminiAPI(input, `You are a Seoul guide. Context: ${JSON.stringify(itinerary)}. Lang: ${lang}. Keep it short.`);
        setMessages(prev => [...prev, { role: 'model', text: result.success ? result.data : "Network error." }]);
        setLoading(false);
      };
      return (
        <>
          {!isOpen && <button onClick={() => setIsOpen(true)} className="fixed bottom-6 right-6 bg-gradient-to-br from-rose-400 to-rose-500 text-white p-4 rounded-full shadow-lg hover:scale-105 transition-all z-40"><Bot size={28} /></button>}
          {isOpen && (
            <div className="fixed bottom-6 right-6 w-[90vw] md:w-[380px] h-[500px] bg-white rounded-3xl shadow-2xl z-50 flex flex-col overflow-hidden border border-rose-100 animate-fade-in">
              <div className="bg-gradient-to-r from-rose-400 to-rose-500 p-4 flex justify-between text-white"><div className="flex gap-2 items-center"><Sparkles size={18} /><h3>{UI_LABELS[lang].aiChat}</h3></div><button onClick={() => setIsOpen(false)}><X size={20} /></button></div>
              <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-stone-50" ref={scrollRef}>
                {messages.map((m, i) => (<div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[85%] rounded-2xl p-3 text-sm ${m.role === 'user' ? 'bg-rose-400 text-white' : 'bg-white shadow-sm'}`}>{m.text}</div></div>))}
                {loading && <Loader2 className="animate-spin text-rose-400" />}
              </div>
              <div className="p-3 border-t"><div className="flex gap-2 bg-stone-100 rounded-full px-4 py-2"><input className="flex-1 bg-transparent outline-none text-sm" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} placeholder={UI_LABELS[lang].chatPlaceholder} /><button onClick={handleSend}><Send size={18} className="text-rose-400" /></button></div></div>
            </div>
          )}
        </>
      );
    };

    const AddEventModal = ({ onClose, onSave, lang }) => {
      const [time, setTime] = useState('');
      const [title, setTitle] = useState('');
      const handleSave = () => { if (!title) return; onSave(time || '00:00', title); };
      return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[80] flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-in">
            <div className="bg-rose-400 p-4 text-white font-bold text-center">{UI_LABELS[lang].addModalTitle}</div>
            <div className="p-5 space-y-4">
              <div><label className="block text-xs text-stone-500 mb-1">{UI_LABELS[lang].addModalTime}</label><input type="time" className="w-full border border-stone-200 rounded-lg p-2 text-stone-700 outline-none focus:ring-2 focus:ring-rose-300" value={time} onChange={(e) => setTime(e.target.value)} /></div>
              <div><label className="block text-xs text-stone-500 mb-1">{UI_LABELS[lang].addModalContent}</label><input type="text" className="w-full border border-stone-200 rounded-lg p-2 text-stone-700 outline-none focus:ring-2 focus:ring-rose-300" value={title} onChange={(e) => setTitle(e.target.value)} /></div>
              <div className="flex gap-3 pt-2"><button onClick={onClose} className="flex-1 py-2 rounded-lg bg-stone-100 text-stone-600 font-bold text-sm">{UI_LABELS[lang].addModalCancel}</button><button onClick={handleSave} className="flex-1 py-2 rounded-lg bg-rose-400 text-white font-bold text-sm shadow-md">{UI_LABELS[lang].addModalSubmit}</button></div>
            </div>
          </div>
        </div>
      );
    };

    const loadData = (language) => {
        const key = `seoul_trip_2025_${language}`;
        try { 
          const saved = localStorage.getItem(key); 
          if (saved) {
            // Migration logic for Day 0 string items to objects
            const parsed = JSON.parse(saved);
            if (parsed && parsed[0] && parsed[0].activities) {
               parsed[0].activities.forEach(act => {
                  if (act.items && act.items.length > 0 && typeof act.items[0] === 'string') {
                     act.items = act.items.map(text => ({ text, checked: false }));
                  }
               });
            }
            return parsed; 
          }
        } catch (e) { console.error("Failed to load itinerary", e); }
        return getInitialItinerary(language);
    };

    function App() {
      const [lang, setLang] = useState('ZH');
      const [activeDay, setActiveDay] = useState(0);
      const [itinerary, setItinerary] = useState(() => loadData('ZH'));
      const [selectedActivity, setSelectedActivity] = useState(null);
      const [showAddEventModal, setShowAddEventModal] = useState(false);
      
      const touchStartX = useRef(null);
      const onTouchStart = e => touchStartX.current = e.targetTouches[0].clientX;
      const onTouchEnd = e => { if (!touchStartX.current) return; const diff = touchStartX.current - e.changedTouches[0].clientX; if (diff > 50 && activeDay < itinerary.length - 1) setActiveDay(p => p + 1); if (diff < -50 && activeDay > 0) setActiveDay(p => p - 1); };
      const getInitialActiveDay = () => { const now = new Date(); const year = now.getFullYear(); const month = now.getMonth(); const date = now.getDate(); if (year === 2025 && month === 11 && date >= 18 && date <= 24) return date - 18 + 1; return 0; };

      useEffect(() => { setActiveDay(getInitialActiveDay()); }, []);
      useEffect(() => { const key = `seoul_trip_2025_${lang}`; localStorage.setItem(key, JSON.stringify(itinerary)); }, [itinerary, lang]);

      // Manual save button logic
      const forceSave = () => {
          const key = `seoul_trip_2025_${lang}`; 
          localStorage.setItem(key, JSON.stringify(itinerary));
          alert('行程已儲存！');
      };

      // Language switch handler
      const handleLangChange = (newLang) => {
          setLang(newLang);
          const savedData = loadData(newLang);
          setItinerary(savedData);
      };

      const updateActivity = (d, a, f, v) => { 
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[d] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[a] };
        newActivity[f] = v;
        newActivities[a] = newActivity;
        newDay.activities = newActivities;
        newItinerary[d] = newDay;
        setItinerary(newItinerary); 
      };
      
      const updateTheme = (d, v) => { 
        const newItinerary = [...itinerary]; 
        newItinerary[d] = { ...newItinerary[d], theme: v };
        setItinerary(newItinerary); 
      };
      
      const handleSaveNewEvent = (time, title) => {
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[activeDay] };
        const newActivities = [...newDay.activities];
        newActivities.push({ time: time, title: title, type: 'default', desc: '點擊編輯內容', location: title, transport: '' });
        newActivities.sort((a, b) => { const tA = a.time || "99:99"; const tB = b.time || "99:99"; return tA.localeCompare(tB); });
        newDay.activities = newActivities;
        newItinerary[activeDay] = newDay;
        setItinerary(newItinerary);
        setShowAddEventModal(false);
      };
      
      // --- Day 0 Checklist Logic ---
      const toggleCheck = (dayIdx, actIdx, itemIdx) => {
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[dayIdx] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[actIdx] };
        const newItems = [...newActivity.items];
        
        // Toggle checked state
        newItems[itemIdx] = { ...newItems[itemIdx], checked: !newItems[itemIdx].checked };
        
        newActivity.items = newItems;
        newActivities[actIdx] = newActivity;
        newDay.activities = newActivities;
        newItinerary[dayIdx] = newDay;
        setItinerary(newItinerary);
      };

      const updateChecklistItemText = (dayIdx, actIdx, itemIdx, text) => {
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[dayIdx] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[actIdx] };
        const newItems = [...newActivity.items];
        
        newItems[itemIdx] = { ...newItems[itemIdx], text: text };
        
        newActivity.items = newItems;
        newActivities[actIdx] = newActivity;
        newDay.activities = newActivities;
        newItinerary[dayIdx] = newDay;
        setItinerary(newItinerary);
      };

      const addChecklistItem = (dayIdx, actIdx) => {
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[dayIdx] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[actIdx] };
        const newItems = [...newActivity.items];
        
        newItems.push({ text: '點擊編輯新項目', checked: false });
        
        newActivity.items = newItems;
        newActivities[actIdx] = newActivity;
        newDay.activities = newActivities;
        newItinerary[dayIdx] = newDay;
        setItinerary(newItinerary);
      };

      const deleteChecklistItem = (dayIdx, actIdx, itemIdx) => {
        if (!confirm('確定刪除此項目？')) return;
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[dayIdx] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[actIdx] };
        const newItems = [...newActivity.items];
        
        newItems.splice(itemIdx, 1);
        
        newActivity.items = newItems;
        newActivities[actIdx] = newActivity;
        newDay.activities = newActivities;
        newItinerary[dayIdx] = newDay;
        setItinerary(newItinerary);
      };

      const currentDay = itinerary[activeDay];

      return (
        <div className="min-h-screen bg-[#fdf8f9] font-sans pb-20 relative">
          <header className="sticky top-0 z-40 bg-[#fdf8f9]/90 backdrop-blur-lg border-b border-rose-100 shadow-sm">
            <div className="max-w-3xl mx-auto px-4 pt-3 pb-0"> 
              <div className="flex flex-row justify-between items-start gap-2 mb-1">
                <div className="flex flex-col items-start gap-1 min-w-0">
                  <h1 className="text-xl md:text-3xl font-bold text-rose-950 tracking-tight truncate w-full">{UI_LABELS[lang].title}</h1>
                  {UI_LABELS[lang].subtitle && <span className="text-xs md:text-sm text-rose-700/70 truncate w-full">{UI_LABELS[lang].subtitle}</span>}
                  <RealTimeDateDisplay />
                </div>
                <div className="flex flex-col items-end gap-2 shrink-0">
                   <TimeWeatherWidget />
                   <div className="flex bg-rose-100/50 p-1 rounded-full">{Object.keys(LANGUAGES).map(l => <button key={l} onClick={() => handleLangChange(l)} className={`px-2 py-1 rounded-full text-[10px] font-bold transition-all ${lang === l ? 'bg-white text-rose-600 shadow-sm' : 'text-rose-400'}`}>{l}</button>)}</div>
                </div>
              </div>
            </div>
            <div className="max-w-3xl mx-auto px-2 overflow-x-auto no-scrollbar pb-2">
              <div className="flex space-x-2 py-2 min-w-max">
                {itinerary.map((day, idx) => (
                  <button key={idx} onClick={() => setActiveDay(idx)} className={`flex flex-col items-center min-w-[4rem] py-2 px-2 rounded-2xl border transition-all ${activeDay === idx ? 'bg-rose-400 border-rose-400 text-white shadow-md scale-105' : 'bg-white border-rose-100 text-stone-400'}`}>
                    <span className="text-[10px] font-bold opacity-80">{UI_LABELS[lang].days[idx]}</span>
                    <span className="text-sm font-bold mt-0.5">{day.date.split(' ')[0]}</span>
                  </button>
                ))}
              </div>
            </div>
          </header>
          <main className="max-w-3xl mx-auto px-4 py-4 pb-20 relative min-h-[60vh]" onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
            <div key={activeDay} className="animate-fade-in">
              <div className="mb-6 pl-2 border-l-4 border-rose-300 flex justify-between items-center">
                <div>
                  <div className="text-stone-400 text-sm font-medium mb-0.5">{currentDay.date}</div>
                  <h2 className="text-xl font-bold text-stone-800"><EditableText text={currentDay.theme} onSave={(v) => updateTheme(activeDay, v)} /></h2>
                </div>
                <div className="flex gap-2">
                  <button onClick={forceSave} className="flex items-center gap-1 text-xs font-bold text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full shadow-sm hover:bg-emerald-100 transition-colors shrink-0"><Save size={14} /><span>儲存</span></button>
                  {/* Hide Add Event button on Day 0, Day 1, and Day 7 (indices 0, 1, 7) */}
                  {activeDay !== 0 && activeDay !== 1 && activeDay !== 7 && (
                    <button onClick={() => setShowAddEventModal(true)} className="flex items-center gap-1 text-xs font-bold text-white bg-rose-400 px-3 py-1.5 rounded-full shadow-sm hover:bg-rose-500 transition-colors shrink-0"><Plus size={14} /><span>{UI_LABELS[lang].addEvent}</span></button>
                  )}
                </div>
              </div>
              <div className="relative space-y-6 pl-4 border-l-2 border-rose-100 ml-3">
                {currentDay.activities.map((item, i) => (
                  <div key={i} className="relative group">
                    <div className={`absolute -left-[25px] mt-1 w-8 h-8 rounded-full border-4 border-white shadow-sm flex items-center justify-center ${item.type.includes('warning') ? 'bg-amber-100 text-amber-600' : (item.type === 'checklist' ? 'bg-emerald-100 text-emerald-600' : (item.type === 'ses' ? 'bg-blue-100 text-blue-500' : 'bg-rose-100 text-rose-500'))}`}>
                      <IconType type={item.type} className="w-4 h-4" />
                    </div>
                    <div className={`bg-white rounded-2xl p-4 shadow-sm border hover:shadow-md transition-shadow ${item.type.includes('warning') ? 'border-amber-200 bg-amber-50/30' : (item.type === 'checklist' ? 'border-emerald-100' : (item.type === 'ses' ? 'border-blue-200 bg-blue-50/30' : 'border-stone-100'))}`}>
                      
                      {/* Day 0: Checklist/Warning/SeS Mode */}
                      {item.type === 'checklist' || item.type.includes('warning') || item.type === 'doc' || item.type === 'ses' ? (
                        <div>
                           <div className="flex items-center gap-2 mb-2">
                              <h3 className={`font-bold text-lg ${item.type.includes('warning') ? 'text-amber-700' : (item.type === 'ses' ? 'text-blue-800' : 'text-stone-800')}`}>{item.title}</h3>
                           </div>
                           <p className="text-sm text-stone-500 mb-3">{item.desc}</p>
                           <ul className="space-y-2">
                             {item.items && item.items.map((subItem, subIdx) => (
                               <li key={subIdx} className="flex items-start gap-2 text-sm text-stone-700 group/item">
                                  {item.type !== 'ses' && (
                                    <input 
                                      type="checkbox" 
                                      checked={subItem.checked || false}
                                      onChange={() => toggleCheck(activeDay, i, subIdx)}
                                      className={`mt-1 w-4 h-4 rounded border-gray-300 focus:ring-rose-400 cursor-pointer ${item.type.includes('warning') ? 'accent-amber-500' : 'accent-emerald-500'}`} 
                                    />
                                  )}
                                  <span className={`flex-1 break-words ${item.type === 'ses' ? 'text-blue-700 font-medium' : (subItem.checked ? 'line-through text-stone-400' : '')}`}>
                                    {item.type === 'ses' ? subItem.text : (
                                      <EditableText 
                                        text={subItem.text} 
                                        onSave={(val) => updateChecklistItemText(activeDay, i, subIdx, val)} 
                                        className="w-full"
                                      />
                                    )}
                                  </span>
                                  {item.type !== 'ses' && (
                                    <button 
                                      onClick={() => deleteChecklistItem(activeDay, i, subIdx)}
                                      className="opacity-0 group-hover/item:opacity-100 text-stone-400 hover:text-red-400 transition-opacity"
                                    >
                                      <Trash2 size={14} />
                                    </button>
                                  )}
                               </li>
                             ))}
                           </ul>
                           {item.type !== 'ses' && (
                             <button 
                               onClick={() => addChecklistItem(activeDay, i)}
                               className="mt-3 text-xs flex items-center gap-1 text-stone-400 hover:text-rose-500 transition-colors"
                             >
                               <Plus size={12} /> {UI_LABELS[lang].addItem}
                             </button>
                           )}
                        </div>
                      ) : (
                        /* Normal Itinerary Mode */
                        <div>
                          {/* Updated Header Row: Flex Row for alignment */}
                          <div className="flex justify-between items-center mb-2 pb-2 border-b border-stone-50">
                            <div className="flex items-center gap-2 overflow-hidden">
                               <span className="font-mono text-rose-500 font-bold bg-rose-50 px-1.5 rounded text-sm shrink-0"><EditableText text={item.time} onSave={(v) => updateActivity(activeDay, i, 'time', v)} /></span>
                               <h3 className="font-bold text-stone-800 truncate"><EditableText text={item.title} onSave={(v) => updateActivity(activeDay, i, 'title', v)} /></h3>
                            </div>
                            
                            {/* Weather Widget Fixed to Right */}
                            <ActivityWeather day={activeDay} index={i} location={item.location} />
                          </div>

                          <div className="text-stone-600 text-sm mb-3 leading-relaxed"><EditableText multiline text={item.desc} onSave={(v) => updateActivity(activeDay, i, 'desc', v)} /></div>
                          
                          <button onClick={() => setSelectedActivity(item)} className="flex items-center gap-1 text-[10px] font-bold text-rose-500 bg-rose-50 px-2 py-1 rounded hover:bg-rose-100 transition-colors w-fit mb-2">
                            <Sparkles size={10} />{UI_LABELS[lang].genPhrases}
                          </button>

                          {(item.location || item.transport || item.duration) && (
                            <div className="text-xs text-stone-400 space-y-1">
                              {item.location && (
                                <div className="flex gap-1 items-center">
                                  <a 
                                    href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`} 
                                    target="_blank" 
                                    rel="noopener noreferrer"
                                    className="flex items-center gap-1 text-rose-400 hover:text-rose-600 transition-colors group/map"
                                    onClick={(e) => e.stopPropagation()}
                                  >
                                    <MapPin size={10} className="group-hover/map:scale-110 transition-transform" />
                                    <span className="border-b border-transparent group-hover/map:border-rose-400">{item.location}</span>
                                  </a>
                                </div>
                              )}
                              {item.transport && <div className="flex gap-1 items-center"><Navigation size={10} />{item.transport}</div>}
                            </div>
                          )}
                        </div>
                      )}

                    </div>
                  </div>
                ))}
              </div>
            </div>
          </main>

          <AIChatWidget itinerary={itinerary} lang={lang} />
          {selectedActivity && <MagicPhraseModal activity={selectedActivity} lang={lang} onClose={() => setSelectedActivity(null)} />}
          {showAddEventModal && <AddEventModal onClose={() => setShowAddEventModal(false)} onSave={handleSaveNewEvent} lang={lang} />}
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
