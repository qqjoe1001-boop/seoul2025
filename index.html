<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2025 Seoul Travel Guide</title>
  
  <!-- PWA 設定 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Seoul2025">
  <meta name="application-name" content="Seoul2025">
  <meta name="theme-color" content="#fdf8f9">
  <meta name="mobile-web-app-capable" content="yes">

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23fb7185' rx='100'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='120' fill='white'%3ESEOUL%3C/text%3E%3Ctext x='50%25' y='70%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='80' fill='white'%3E2025%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23fb7185' rx='100'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='120' fill='white'%3ESEOUL%3C/text%3E%3Ctext x='50%25' y='70%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='80' fill='white'%3E2025%3C/text%3E%3C/svg%3E">
  
  <link rel="manifest" href='data:application/manifest+json,{"name":"Seoul2025","short_name":"Seoul2025","start_url":".","display":"standalone","background_color":"#fdf8f9","theme_color":"#fdf8f9","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27512%27 height=%27512%27 viewBox=%270 0 512 512%27%3E%3Crect width=%27512%27 height=%27512%27 fill=%27%23fb7185%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27bold%27 font-size=%27120%27 fill=%27white%27%3ESEOUL%3C/text%3E%3Ctext x=%2750%25%27 y=%2770%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27bold%27 font-size=%2780%27 fill=%27white%27%3E2025%3C/text%3E%3C/svg%3E","sizes":"192x192","type":"image/svg+xml","purpose":"any maskable"},{"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27512%27 height=%27512%27 viewBox=%270 0 512 512%27%3E%3Crect width=%27512%27 height=%27512%27 fill=%27%23fb7185%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27bold%27 font-size=%27120%27 fill=%27white%27%3ESEOUL%3C/text%3E%3Ctext x=%2750%25%27 y=%2770%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27bold%27 font-size=%2780%27 fill=%27white%27%3E2025%3C/text%3E%3C/svg%3E","sizes":"512x512","type":"image/svg+xml","purpose":"any maskable"}]}'>

  <!-- 載入 Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 載入 Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { font-family: sans-serif; background-color: #fdf8f9; user-select: none; -webkit-user-select: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
    
    /* Mic pulse animation */
    @keyframes pulse-mic {
      0% { box-shadow: 0 0 0 0 rgba(251, 113, 133, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(251, 113, 133, 0); }
      100% { box-shadow: 0 0 0 0 rgba(251, 113, 133, 0); }
    }
    .animate-pulse-mic { animation: pulse-mic 1.5s infinite; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React 程式碼 -->
  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    import { 
      Plane, Train, Bus, MapPin, Music, Coffee, Camera, Moon, Sun, Cloud, 
      Snowflake, Clock, Edit3, Globe, ChevronRight, Navigation, Footprints, 
      Utensils, ShoppingBag, BedDouble, Ticket, Home, Ship, Car, Sparkles, 
      MessageCircle, X, Send, Loader2, Languages, Bot, AlertTriangle, Volume2,
      ClipboardCheck, FileText, AlertCircle, Briefcase, Scan, CloudRain, Mic, Wand2, Plus, Save, Check, Trash2, Banknote, Settings
    } from 'https://esm.sh/lucide-react@0.263.1';

    // --- 設定 ---
    const LANGUAGES = { ZH: 'ZH', KR: 'KR', EN: 'EN', JP: 'JP' };
    const UI_LABELS = {
      ZH: { title: '2025 首爾之旅', subtitle: '圭賢演唱會・冬日首爾', editTip: '點擊文字即可編輯', days: ['準備', 'Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'], transport: '交通', estTime: '時間', location: '地點', aiChat: 'AI 隨身導遊', genPhrases: '韓語幫手', phrasesTitle: '✨ 情境韓語小幫手', chatPlaceholder: '問問 AI...', close: '關閉', fallbackMsg: 'AI 連線異常', addEvent: '新增行程', addModalTitle: '新增行程', addModalTime: '時間 (24小時制)', addModalContent: '地點 / 活動內容', addModalSubmit: '儲存並排序', addModalCancel: '取消', addItem: '新增項目', splitBill: '分帳', settings: '設定', apiKeyPlaceholder: '輸入 Gemini API Key', total: '總支出', perPerson: '每人應付', rate: '匯率' },
      KR: { title: '2025 서울 여행', subtitle: '규현 콘서트 • 겨울 서울', editTip: '클릭하여 편집', days: ['준비', '1일차', '2일차', '3일차', '4일차', '5일차', '6일차', '7일차'], transport: '교통', estTime: '시간', location: '장소', aiChat: 'AI 가이드', genPhrases: '한국어 도우미', phrasesTitle: '✨ 한국어', chatPlaceholder: '질문...', close: '닫기', fallbackMsg: 'AI 오류', addEvent: '일정 추가', addModalTitle: '추가', addModalTime: '시간', addModalContent: '내용', addModalSubmit: '저장', addModalCancel: '취소', addItem: '항목 추가', splitBill: '정산', settings: '설정', apiKeyPlaceholder: 'API Key 입력', total: '총 지출', perPerson: '1인당', rate: '환율' },
      EN: { title: 'Seoul Trip 2025', subtitle: 'Kyuhyun Concert • Winter Seoul', editTip: 'Click to edit', days: ['Prep', 'Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'], transport: 'Transport', estTime: 'Time', location: 'Loc', aiChat: 'AI Guide', genPhrases: 'Helper', phrasesTitle: '✨ Phrases', chatPlaceholder: 'Ask AI...', close: 'Close', fallbackMsg: 'AI Offline', addEvent: 'Add', addModalTitle: 'Add Event', addModalTime: 'Time', addModalContent: 'Content', addModalSubmit: 'Save', addModalCancel: 'Cancel', addItem: 'Add Item', splitBill: 'Split Bill', settings: 'Settings', apiKeyPlaceholder: 'Enter API Key', total: 'Total', perPerson: 'Per Person', rate: 'Rate' },
      JP: { title: '2025 ソウル旅行', subtitle: 'キュヒョンコンサート・冬のソウル', editTip: 'クリックして編集', days: ['準備', '1日目', '2日目', '3日目', '4日目', '5日目', '6日目', '7日目'], transport: '交通', estTime: '時間', location: '場所', aiChat: 'AI ガイド', genPhrases: '韓国語ヘルプ', phrasesTitle: '✨ 韓国語', chatPlaceholder: '質問...', close: '閉じる', fallbackMsg: 'AIエラー', addEvent: '追加', addModalTitle: '追加', addModalTime: '時間', addModalContent: '内容', addModalSubmit: '保存', addModalCancel: 'キャンセル', addItem: '追加', splitBill: '割り勘', settings: '設定', apiKeyPlaceholder: 'APIキーを入力', total: '合計', perPerson: '一人当たり', rate: 'レート' }
    };

    const FALLBACK_PHRASES_BY_TYPE = {
      food: [{ korean: '메뉴판 좀 주세요', pronunciation: 'Menyupan jom juseyo', meaning: '請給我菜單' }, { korean: '이거 주세요', pronunciation: 'Ige juseyo', meaning: '請給我這個' }, { korean: '계산해 주세요', pronunciation: 'Gyesanhae juseyo', meaning: '請結帳' }],
      shopping: [{ korean: '이거 얼마예요?', pronunciation: 'Ige eolmayeyo?', meaning: '這個多少錢?' }, { korean: '깎아주세요', pronunciation: 'Kkakkajuseyo', meaning: '請算便宜一點' }, { korean: '입어봐도 돼요?', pronunciation: 'Ibeobwado dwaeyo?', meaning: '可以試穿嗎?' }],
      transport: [{ korean: '이 버스 명동 가나요?', pronunciation: 'I beoseu Myeongdong ganayo?', meaning: '這班公車去明洞嗎?' }, { korean: '여기서 내려주세요', pronunciation: 'Yeogiseo naeryeojuseyo', meaning: '請在這裡讓我下車' }],
      default: [{ korean: '안녕하세요', pronunciation: 'Annyeonghaseyo', meaning: '你好' }, { korean: '감사합니다', pronunciation: 'Gamsahamnida', meaning: '謝謝' }, { korean: '화장실 어디예요?', pronunciation: 'Hwajangsil eodiyeyo?', meaning: '洗手間在哪裡?' }]
    };

    // --- 地鐵顏色 ---
    const SUBWAY_COLORS = {
      '1': '#0052A4', '2': '#00A84D', '3': '#EF7C1C', '4': '#00A5DE',
      '5': '#996CAC', '6': '#CD7C2F', '7': '#747F00', '8': '#E6186C', '9': '#BDB092',
      'AREX': '#0090D2', 'A': '#0090D2', 'K': '#77C4A3', 'B': '#E7E727', 'S': '#A71E31'
    };

    // --- API ---
    const getApiKeyFromStorage = () => localStorage.getItem('gemini_api_key') || "";

    const callGeminiAPI = async (prompt, systemInstruction = "") => {
      const apiKey = getApiKeyFromStorage();
      if (!apiKey) return { success: false, error: "Please set API Key in Settings" };
      
      const models = [
          'gemini-1.5-flash',
          'gemini-2.0-flash-exp',
          'gemini-1.5-pro'
      ];

      const payload = {
         contents: [{ parts: [{ text: systemInstruction ? `${systemInstruction}\n\n${prompt}` : prompt }] }]
      };

      for (const model of models) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
        try {
          const response = await fetch(url, { 
              method: 'POST', 
              headers: { 'Content-Type': 'application/json' }, 
              body: JSON.stringify(payload) 
          });
          
          if (response.ok) {
             const data = await response.json();
             return { success: true, data: data.candidates?.[0]?.content?.parts?.[0]?.text };
          }
        } catch (e) { 
           console.warn(`Model ${model} failed`, e);
        }
      }
      return { success: false, error: "All models failed. Check API Key." };
    };

    // --- Data Helper ---
    const toObj = (item) => (typeof item === 'string' ? { text: item, checked: false } : item);

    // --- Data ---
    const getInitialItinerary = (lang) => {
      const checklist = ['護照 (效期6個月以上) / Esim卡', '錢包整理 (現金/信用卡/機票)', '手機充電板 / 手錶充電線 / 轉接頭(4.8mm)', '耳機 / 行動電源 (需手提)', '梳洗刷牙用品 / 保養及卸妝用品', '護髮整髮梳子 / 眼鏡', '每日衣服 / 內衣褲 / 襪子', '睡衣褲 / 拖鞋 / 護膝', '熱水瓶 / 保暖衣物', '一般藥品 / 口罩'].map(toObj);
      const sesItems = ['地點：T1 入境審查大廳 F 區', '時間：07:00 - 18:00', '流程：下機 -> 找 F 區登記中心 -> 拍照/指紋 -> 自動通關', '備案：若錯過，入境後至 3 樓出境大廳 G 區辦理'].map(toObj);
      
      const day0_ZH = {
        day: 0, date: '出發前', theme: '行前準備 & SeS申請',
        activities: [
          { title: '必備行李清單', type: 'checklist', desc: '出發前請務必確認以下物品：', items: checklist },
          { title: '仁川機場 SeS 自動通關申請', type: 'ses', desc: '台灣旅客可於 T1 入境審查 F 區直接辦理。', items: sesItems },
          { title: '不可手提 / 必須託運', type: 'warning', desc: '液體 > 100ml, 刀剪工具。', items: ['大瓶化妝水/乳液', '修眉刀/指甲剪', '腳架/自拍棒 (管徑>1cm, 長>60cm)'].map(toObj) },
          { title: '不可託運 / 必須手提', type: 'warning_red', desc: '電池類務必隨身攜帶！', items: ['行動電源', '鋰電池', '筆電/平板', '電子菸'].map(toObj) },
          { title: '旅行文件', type: 'doc', desc: '建議備份：', items: ['Q-CODE', '訂房確認單', '演唱會門票', '保險單'].map(toObj) }
        ]
      };
      const day0_KR = { day: 0, date: '출발 전', theme: '준비 & SeS', activities: [{ title: '필수 준비물', type: 'checklist', desc: '확인:', items: ['여권/Esim', '지갑', '충전기', '보조배터리', '세면도구', '옷/속옷/양말', '상비약'].map(toObj) }, { title: 'SeS 신청', type: 'ses', desc: '인천 T1 입국심사 F구역', items: ['위치: F구역', '시간: 07:00-18:00'].map(toObj) }, { title: '위탁 필수', type: 'warning', desc: '100ml 초과 액체', items: ['화장품', '칼'].map(toObj) }, { title: '기내 반입', type: 'warning_red', desc: '배터리', items: ['보조배터리', '노트북'].map(toObj) }, { title: '서류', type: 'doc', desc: '준비:', items: ['Q-CODE', '예약확인서'].map(toObj) }] };
      const day0_EN = { day: 0, date: 'Pre-trip', theme: 'Prep & SeS', activities: [{ title: 'Checklist', type: 'checklist', desc: 'Essentials:', items: ['Passport/Esim', 'Wallet', 'Chargers', 'Power Bank', 'Toiletries', 'Clothes', 'Medicine'].map(toObj) }, { title: 'SeS Registration', type: 'ses', desc: 'Incheon T1 Area F', items: ['Loc: Area F', 'Time: 07:00-18:00'].map(toObj) }, { title: 'Check-in Only', type: 'warning', desc: 'Liquids > 100ml', items: ['Liquids', 'Scissors'].map(toObj) }, { title: 'Carry-on Only', type: 'warning_red', desc: 'Batteries', items: ['Power Bank', 'Laptop'].map(toObj) }, { title: 'Docs', type: 'doc', desc: 'Papers:', items: ['Q-CODE', 'Booking'].map(toObj) }] };
      const day0_JP = { day: 0, date: '出発前', theme: '準備 & SeS', activities: [{ title: '必需品', type: 'checklist', desc: '確認:', items: ['パスポート/Esim', '財布', '充電器', 'バッテリー', '洗面用具', '着替え', '薬'].map(toObj) }, { title: 'SeS 登録', type: 'ses', desc: '仁川 T1 Fエリア', items: ['場所: Fエリア', '時間: 07:00-18:00'].map(toObj) }, { title: '預け入れ', type: 'warning', desc: '液体100ml超', items: ['化粧水', '刃物'].map(toObj) }, { title: '機内持込', type: 'warning_red', desc: '電池類', items: ['バッテリー', 'PC'].map(toObj) }, { title: '書類', type: 'doc', desc: '書類:', items: ['Q-CODE', '予約確認書'].map(toObj) }] };

      const days_ZH = [
          { day: 1, date: '12/18 (四)', theme: '抵達首爾 & 飯店入住', activities: [{ time: '12:00', title: '從溫暖的家出發', type: 'car', desc: '預約肯驛機場接送至桃園機場。', location: 'Home', transport: '專車' }, { time: '15:15', title: '長榮 BR160 起飛', type: 'flight', desc: '桃園機場 (TPE) 第二航廈 -> 仁川機場 (ICN)', location: 'TPE Airport' }, { time: '18:45', title: '抵達仁川機場 & 入境', type: 'arrival', desc: '辦理入境手續、領取行李、購買 T-Money 卡', location: 'ICN Airport' }, { time: '20:00', title: '前往 Wecostay Namsan', type: 'bus', desc: '搭乘 6015 巴士至忠武路站。', info: '費用: 17,000 KRW / 約 70-80 分鐘', customPhrases: [{ korean: 'G3 호텔에서 내려주세요', pronunciation: 'G3 Hotel-eseo naeryeojuseyo', meaning: '我們到 G3 Hotel 下車，謝謝' }], transport: '仁川機場 5B/11B 站牌搭乘【6015 機場巴士】(往明洞方向)，經過 3 站(約70分鐘)，於「忠武路站」下車，下車後往回走約 2 分鐘即達。' }, { time: '21:30', title: '飯店 Check-in & 晚餐', type: 'food', desc: '辦理入住後，於忠武路附近享用韓式炸雞或部隊鍋。', location: 'Chungmuro' }] },
          { day: 2, date: '12/19 (五)', theme: '歷史漫步 & 傳統韻味', activities: [{ time: '10:00', title: '景福宮', type: 'sight', desc: '參觀光化門與景福宮守門將換崗儀式 (10:00)。', location: 'Gyeongbokgung', transport: '3號線 忠武路站 -> (往大化方向，3站) -> 景福宮站 (5號出口)，出站後直走即達光化門廣場。' }, { time: '12:30', title: '土俗村蔘雞湯', type: 'food', desc: '享用著名的蔘雞湯暖身。', location: 'Seochon', transport: '徒步：從景福宮站 2 號出口出來，直走約 120 公尺，在 GS25 便利商店左轉進入紫霞門路 5 巷，直走即達。' }, { time: '14:30', title: '北村韓屋村 & 三清洞', type: 'walk', desc: '漫步於傳統韓屋群，尋找北村八景，隨後在三清洞咖啡廳休息。', location: 'Bukchon', transport: '徒步：沿著景福宮石牆路往東走，經過國立民俗博物館，穿越三清洞路，步行約 15-20 分鐘。' }, { time: '18:00', title: '仁寺洞步行街', type: 'shopping', desc: '參觀人人廣場 (Ssamzigil)，購買傳統工藝品。', location: 'Insadong', transport: '徒步：從北村沿著安國站方向往南走，過馬路即進入仁寺洞主街 (約 10 分鐘)。' }, { time: '20:00', title: '清溪川夜間散步', type: 'walk', desc: '欣賞清溪川聖誕燈飾 (如有活動) 或夜景。', location: 'Cheonggyecheon', transport: '徒步：從仁寺洞主街往南直走，經過鐘閣站，步行約 8 分鐘即可抵達清溪川廣場。' }] },
          { day: 3, date: '12/20 (六)', theme: '首爾全景 & 購物', activities: [{ time: '10:30', title: '南山公園 & N首爾塔', type: 'sight', desc: '搭乘南山纜車上山，俯瞰首爾全景，鎖上愛情鎖。', location: 'Namsan', transport: '徒步+纜車：4號線 明洞站 3號出口，沿著太平洋飯店右側坡道步行約 10 分鐘至纜車搭乘處，搭乘纜車上山。' }, { time: '13:30', title: '南山炸豬排', type: 'food', desc: '嘗試南山腳下著名的巨無霸炸豬排。', location: 'Namsan', transport: '徒步：從纜車站下山後，沿著小坡路往下走約 5 分鐘，即可看到炸豬排一條街。' }, { time: '15:00', title: '明洞商圈購物', type: 'shopping', desc: '美妝、服飾採購，體驗明洞小吃 (雞蛋糕、糖餅)。', location: 'Myeongdong', transport: '徒步：從南山走回明洞站，穿越地下道或斑馬線進入明洞商圈主街。' }, { time: '19:00', title: '亂打秀 (Nanta) 或 休息', type: 'show', desc: '可選擇觀賞韓國著名的無語言音樂劇，或回忠武路附近休息。', location: 'Myeongdong' }] },
          { day: 4, date: '12/21 (日)', theme: '圭賢演唱會 & 韓屋風情', activities: [{ time: '10:00', title: '南山谷韓屋村', type: 'sight', desc: '位於忠武路站旁，輕鬆散步體驗傳統庭園，不需門票。', location: 'Chungmuro', transport: '徒步：從 Wecostay 步行約 5 分鐘，由忠武路站 3 或 4 號出口旁入口進入。' }, { time: '12:00', title: '午餐 & 休息', type: 'food', desc: '在忠武路附近用餐，並回飯店稍作整理，準備前往演唱會。', location: 'Wecostay' }, { time: '14:30', title: '前往 Olympic Hall', type: 'train', desc: '前往奧林匹克公園。', location: 'Olympic Park', transport: '地鐵轉乘：4號線 忠武路站 -> (往當嶺方向，1站) -> 東大門歷史文化公園站，轉乘5號線 (往馬川/河南黔丹山方向，約13站) -> 奧林匹克公園站 (3號出口)。' }, { time: '17:00', title: '2025 KYUHYUN Concert', type: 'music', desc: '“The Classic” 演唱會 @ Olympic Hall。享受圭賢的歌聲！', location: 'Olympic Park' }, { time: '20:30', title: '返回市區 & 晚餐', type: 'food', desc: '演唱會結束後搭地鐵返回，吃頓熱騰騰的烤肉慶功。', location: 'Chungmuro', transport: '地鐵轉乘：原路返回至忠武路站，由 1 號出口步行至烤肉店。' }] },
          { day: 5, date: '12/22 (一)', theme: '現代首爾 & 漢江夜景', activities: [{ time: '11:00', title: 'The Hyundai Seoul', type: 'shopping', desc: '參觀首爾最大的百貨公司。', location: 'Yeouido', transport: '地鐵轉乘：4號線 忠武路站 -> (往當嶺方向，1站) -> 東大門歷史文化公園站，轉乘5號線 (往傍花方向，9站) -> 汝矣尼魯站 (1號出口)，直通百貨。' }, { time: '15:00', title: '汝矣島漢江公園', type: 'walk', desc: '漢江邊散步，租借野餐墊 (若天氣允許) 或在漢江泡麵機煮拉麵。', location: 'Yeouido', transport: '徒步：從 The Hyundai 1 號門出來，過馬路即達汝矣島漢江公園。' }, { time: '17:00', title: '漢江遊覽船', type: 'ship', desc: 'Eland Cruise 欣賞漢江夜景。', location: 'Yeouido Dock', transport: '徒步：沿著漢江公園江邊往東走 (看到 E-land 標誌)，步行約 10-15 分鐘至 2 號碼頭。' }, { time: '19:30', title: '弘大晚餐', type: 'food', desc: '前往充滿年輕活力的弘大商圈享用晚餐。', location: 'Hongdae', transport: '地鐵轉乘：5號線 汝矣尼魯站 -> (往傍花方向，2站) -> 永登浦區廳站，轉乘2號線 (往合井/弘大方向，2站) -> 弘大入口站 (9號出口)。' }] },
          { day: 6, date: '12/23 (二)', theme: '伴手禮採買 & 悠閒時光', activities: [{ time: '10:30', title: '廣藏市場', type: 'food', desc: '品嚐綠豆煎餅、生牛肉、麻藥飯捲。', location: 'Gwangjang Market', transport: '地鐵轉乘：4號線 忠武路站 -> (往當嶺方向，2站) -> 東大門站，轉乘1號線 (往首爾站方向，1站) -> 鐘路5街站 (8號出口即是市場入口)。' }, { time: '14:00', title: '樂天超市', type: 'shopping', desc: '首爾站店。採購零食、泡麵、海苔等伴手禮。', location: 'Seoul Station', transport: '地鐵直達：由鐘路5街站搭乘1號線 (往首爾站/仁川方向，3站) -> 首爾站 (1號出口出來上手扶梯即達)。' }, { time: '17:00', title: '飯店打包 & 休息', type: 'hotel', desc: '將戰利品放回飯店，整理行李。', location: 'Wecostay', transport: '地鐵直達：由首爾站搭乘4號線 (往當嶺方向，2站) -> 忠武路站。' }, { time: '19:00', title: '最後的晚餐', type: 'food', desc: '在乙支路 (Hipjiro) 體驗獨特的巷弄酒吧或烤腸店。', location: 'Euljiro', transport: '徒步：從忠武路站 8 號出口，步行約 5-8 分鐘至乙支路 3 街一帶巷弄。' }] },
          { day: 7, date: '12/24 (三)', theme: '告別首爾 & 返家', activities: [{ time: '06:00', title: '退房 & 前往機場', type: 'bus', desc: '搭乘 6015 機場巴士前往仁川機場 (或搭計程車至首爾站搭 AREX 直達車)。', location: 'Airport Bus Stop', transport: '機場巴士：前往忠武路站 1 號出口前方公車站，搭乘【6015 機場巴士】(往仁川機場方向)，車程約 70-80 分鐘。' }, { time: '07:35', title: '辦理登機 & 退稅', type: 'plane', desc: '長榮航空櫃檯報到，辦理市區退稅單據的海關蓋章 (若需要)。', location: 'ICN Airport' }, { time: '11:40', title: 'BR169 起飛', type: 'flight', desc: '仁川 (ICN) -> 桃園 (TPE)', location: 'Departure Hall' }, { time: '13:30', title: '抵達台灣', type: 'home', desc: '平安抵達溫暖的家。', location: 'Taipei' }] }
      ];

      const days_KR = JSON.parse(JSON.stringify(days_ZH)); 
      const days_EN = JSON.parse(JSON.stringify(days_ZH)); 
      const days_JP = JSON.parse(JSON.stringify(days_ZH)); 

      const data = {
        ZH: [day0_ZH, ...days_ZH],
        KR: [day0_KR, ...days_KR],
        EN: [day0_EN, ...days_EN],
        JP: [day0_JP, ...days_JP]
      };
      return data[lang];
    };

    // --- Components ---
    const IconType = ({ type, className }) => {
      const icons = { 
        checklist: ClipboardCheck, warning: AlertTriangle, warning_red: AlertTriangle, doc: FileText, ses: Scan, 
        flight: Plane, arrival: Plane, bus: Bus, car: Car, train: Train, food: Utensils, music: Music, sight: Camera, shopping: ShoppingBag, hotel: BedDouble, ship: Ship, walk: Footprints, show: Ticket, home: Home, default: MapPin 
      };
      const Icon = icons[type] || icons.default;
      return <Icon className={`${className} ${type === 'arrival' ? 'rotate-90' : ''} ${type === 'warning_red' ? 'text-red-500' : ''} ${type === 'warning' ? 'text-amber-500' : ''} ${type === 'ses' ? 'text-blue-500' : ''}`} />;
    };

    // Transport Formatter Component
    const TransportDisplay = ({ text }) => {
      if (!text) return null;
      
      // Regex to find line patterns: e.g., "1號線", "Line 2", "AREX"
      const parts = text.split(/([1-9]號線|Line\s*[1-9]|AREX|[1-9]호선)/g);
      
      return (
        <span className="inline-flex flex-wrap items-center gap-1 align-middle ml-1">
          {parts.map((part, idx) => {
            let color = null;
            if (part.match(/1號線|Line\s*1|1호선/)) color = SUBWAY_COLORS['1'];
            else if (part.match(/2號線|Line\s*2|2호선/)) color = SUBWAY_COLORS['2'];
            else if (part.match(/3號線|Line\s*3|3호선/)) color = SUBWAY_COLORS['3'];
            else if (part.match(/4號線|Line\s*4|4호선/)) color = SUBWAY_COLORS['4'];
            else if (part.match(/5號線|Line\s*5|5호선/)) color = SUBWAY_COLORS['5'];
            else if (part.match(/6號線|Line\s*6|6호선/)) color = SUBWAY_COLORS['6'];
            else if (part.match(/7號線|Line\s*7|7호선/)) color = SUBWAY_COLORS['7'];
            else if (part.match(/8號線|Line\s*8|8호선/)) color = SUBWAY_COLORS['8'];
            else if (part.match(/9號線|Line\s*9|9호선/)) color = SUBWAY_COLORS['9'];
            else if (part.match(/AREX/i)) color = SUBWAY_COLORS['AREX'];

            if (color) {
              return <span key={idx} className="px-1.5 py-0.5 rounded text-white font-bold text-[10px] inline-block" style={{ backgroundColor: color }}>{part}</span>;
            }
            // Render non-matching parts only if they have meaningful content
            return part.trim() ? <span key={idx} className="text-xs text-stone-500">{part}</span> : null;
          })}
        </span>
      );
    };

    const ActivityWeather = ({ day, index, location }) => {
      const isTaiwan = location && ['Home', 'TPE', 'Taipei', 'Taiwan', 'Taoyuan', '家', '桃園', '台北', '台灣'].some(k => location.includes(k));
      const seed = day * 10 + index;
      let weatherTypes, temp;
      if (isTaiwan) {
        weatherTypes = ['sunny', 'cloudy', 'rain']; 
        temp = Math.floor((seed * 9301 + 49297) % 8) + 15;
      } else {
        weatherTypes = ['sunny', 'cloudy', 'snow'];
        temp = Math.floor((seed * 9301 + 49297) % 15) - 10; 
      }
      const type = weatherTypes[seed % weatherTypes.length];
      const getIcon = () => {
        if (type === 'sunny') return <Sun className="w-3 h-3 text-amber-400" />;
        if (type === 'snow') return <Snowflake className="w-3 h-3 text-sky-300" />;
        if (type === 'rain') return <CloudRain className="w-3 h-3 text-slate-400" />;
        return <Cloud className="w-3 h-3 text-slate-400" />;
      };
      return (
        <div className="flex items-center gap-1 text-[10px] font-medium text-stone-500 bg-stone-50 px-1.5 py-0.5 rounded-full shrink-0 ml-2">
          {getIcon()}
          <span>{temp}°</span>
        </div>
      );
    };

    const TimeWeatherWidget = () => {
      const [time, setTime] = useState(new Date());
      const [temp, setTemp] = useState(-2);
      const [condition, setCondition] = useState('cloudy');
      useEffect(() => { const t = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(t); }, []);
      const seoulTime = new Date(time.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
      const getIcon = () => {
        if (condition === 'sunny') return <Sun className="w-4 h-4 text-amber-400" />;
        if (condition === 'snow') return <Snowflake className="w-4 h-4 text-sky-300" />;
        return <Cloud className="w-4 h-4 text-slate-400" />;
      };
      return (
        <div className="flex flex-col items-end gap-1">
           <div className="flex items-center gap-2 bg-white/80 backdrop-blur-md px-3 py-1 md:px-4 md:py-2 rounded-2xl shadow-sm border border-rose-100">
             <div className="flex flex-col items-end border-r border-rose-100 pr-2 md:pr-4">
               <span className="text-[8px] md:text-[10px] text-rose-800 font-bold tracking-wider">SEOUL</span>
               <span className="text-lg md:text-xl font-mono font-bold text-rose-900 leading-none">{seoulTime.getHours().toString().padStart(2,'0')}:{seoulTime.getMinutes().toString().padStart(2,'0')}</span>
             </div>
             <div className="flex items-center gap-2">{getIcon()}<span className="text-lg font-bold text-stone-700">{temp}°C</span></div>
           </div>
        </div>
      );
    };

    const RealTimeDateDisplay = () => {
      const [dateStr, setDateStr] = useState('');
      useEffect(() => {
        const updateDate = () => {
          const now = new Date();
          const seoulTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
          const y = seoulTime.getFullYear();
          const m = String(seoulTime.getMonth() + 1).padStart(2, '0');
          const d = String(seoulTime.getDate()).padStart(2, '0');
          const days = ['日', '一', '二', '三', '四', '五', '六'];
          const dayName = days[seoulTime.getDay()];
          setDateStr(`${y}/${m}/${d} (${dayName})`);
        };
        updateDate();
        const timer = setInterval(updateDate, 60000);
        return () => clearInterval(timer);
      }, []);
      return <span className="text-sm font-bold text-rose-900/90 mt-0.5 block">{dateStr}</span>;
    };

    const EditableText = ({ text, className, multiline = false, onSave }) => {
      const [isEditing, setIsEditing] = useState(false);
      const [value, setValue] = useState(text);
      useEffect(() => setValue(text), [text]);
      const handleBlur = () => { setIsEditing(false); onSave(value); };
      if (isEditing) return multiline ? <textarea autoFocus className={`w-full bg-white border border-rose-300 rounded p-2 focus:ring-2 focus:ring-rose-400 outline-none text-stone-700 ${className}`} value={value} onChange={(e) => setValue(e.target.value)} onBlur={handleBlur} rows={3} /> : <input autoFocus type="text" className={`w-full bg-white border border-rose-300 rounded px-1 focus:ring-2 focus:ring-rose-400 outline-none text-stone-700 ${className}`} value={value} onChange={(e) => setValue(e.target.value)} onBlur={handleBlur} />;
      return <div onClick={() => setIsEditing(true)} className={`cursor-pointer hover:bg-rose-50/50 rounded px-1 transition-colors border border-transparent hover:border-rose-100 group relative ${className}`}>{value}<Edit3 className="w-3 h-3 text-rose-300 absolute -right-4 top-1 opacity-0 group-hover:opacity-100 transition-opacity" /></div>;
    };

    const MagicPhraseModal = ({ activity, lang, onClose }) => {
      const [phrases, setPhrases] = useState([]);
      const [loading, setLoading] = useState(true);
      const [errorMsg, setErrorMsg] = useState(null);
      const speak = (text) => {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.rate = 0.9;
        window.speechSynthesis.speak(utterance);
      };
      useEffect(() => {
        const generatePhrases = async () => {
          const targetLang = lang === 'ZH' || lang === 'KR' ? 'Traditional Chinese' : (lang === 'JP' ? 'Japanese' : 'English');
          const prompt = `Context: Tourist in Seoul doing "${activity.title}" (${activity.type}). Generate 4 short, useful Korean phrases. Output JSON only: [{"korean": "...", "pronunciation": "...", "meaning": "..."}]. Meaning in ${targetLang}.`;
          const custom = activity.customPhrases || [];
          const result = await callGeminiAPI(prompt, "You are a Korean tutor. Output pure JSON.");
          if (result.success) {
            try {
               const cleanJson = result.data.replace(/```json/g, '').replace(/```/g, '').trim();
               const aiPhrases = JSON.parse(cleanJson);
               setPhrases([...custom, ...aiPhrases]);
            } catch (e) { setPhrases([...custom, ...(FALLBACK_PHRASES_BY_TYPE[activity.type] || FALLBACK_PHRASES_BY_TYPE.default)]); setErrorMsg(UI_LABELS[lang].fallbackMsg); }
          } else {
            setPhrases([...custom, ...(FALLBACK_PHRASES_BY_TYPE[activity.type] || FALLBACK_PHRASES_BY_TYPE.default)]);
            setErrorMsg(UI_LABELS[lang].fallbackMsg);
          }
          setLoading(false);
        };
        generatePhrases();
      }, [activity, lang]);
      return (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[60] flex items-center justify-center p-4" onClick={onClose}>
          <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden animate-fade-in" onClick={(e) => e.stopPropagation()}>
            <div className="bg-gradient-to-r from-rose-300 to-rose-400 p-4 flex justify-between items-center text-white">
              <div className="flex items-center gap-2"><Languages size={20} /><div><h3 className="font-bold text-sm">{UI_LABELS[lang].phrasesTitle}</h3><p className="text-[10px] opacity-90 truncate max-w-[200px]">{activity.title}</p></div></div>
              <button onClick={onClose}><X size={20} /></button>
            </div>
            <div className="p-4 min-h-[200px]">
              {loading ? <div className="flex flex-col items-center justify-center h-32"><Loader2 className="animate-spin text-rose-400" /></div> : (
                <div className="space-y-2">
                  {errorMsg && <div className="flex items-center gap-2 bg-amber-50 text-amber-600 text-xs p-2 rounded">{errorMsg}</div>}
                  {phrases.map((p, i) => (
                    <div key={i} className="bg-rose-50 rounded-xl p-3 border border-rose-100 flex justify-between items-center gap-2">
                      <div className="flex-1"><span className="font-bold text-rose-900 block">{p.korean}</span><div className="text-xs text-rose-600/80">{p.pronunciation}</div><div className="text-sm text-stone-600">{p.meaning}</div></div>
                      <button onClick={() => speak(p.korean)} className="p-2 bg-white text-rose-400 rounded-full shadow-sm"><Volume2 size={18} /></button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const AIChatWidget = ({ itinerary, lang }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [loading, setLoading] = useState(false);
      const scrollRef = useRef(null);
      useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages, isOpen]);
      const handleSend = async () => {
        if (!input.trim()) return;
        const userMsg = { role: 'user', text: input };
        setMessages(prev => [...prev, userMsg]);
        setInput("");
        setLoading(true);
        const result = await callGeminiAPI(input, `You are a Seoul guide. Context: ${JSON.stringify(itinerary)}. Lang: ${lang}. Keep it short.`);
        setMessages(prev => [...prev, { role: 'model', text: result.success ? result.data : "Network error." }]);
        setLoading(false);
      };
      return (
        <>
          {!isOpen && <button onClick={() => setIsOpen(true)} className="fixed bottom-6 right-6 bg-gradient-to-br from-rose-400 to-rose-500 text-white p-4 rounded-full shadow-lg hover:scale-105 transition-all z-40"><Bot size={28} /></button>}
          {isOpen && (
            <div className="fixed bottom-6 right-6 w-[90vw] md:w-[380px] h-[500px] bg-white rounded-3xl shadow-2xl z-50 flex flex-col overflow-hidden border border-rose-100 animate-fade-in">
              <div className="bg-gradient-to-r from-rose-400 to-rose-500 p-4 flex justify-between text-white"><div className="flex gap-2 items-center"><Sparkles size={18} /><h3>{UI_LABELS[lang].aiChat}</h3></div><button onClick={() => setIsOpen(false)}><X size={20} /></button></div>
              <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-stone-50" ref={scrollRef}>
                {messages.map((m, i) => (<div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[85%] rounded-2xl p-3 text-sm ${m.role === 'user' ? 'bg-rose-400 text-white' : 'bg-white shadow-sm'}`}>{m.text}</div></div>))}
                {loading && <Loader2 className="animate-spin text-rose-400" />}
              </div>
              <div className="p-3 border-t"><div className="flex gap-2 bg-stone-100 rounded-full px-4 py-2"><input className="flex-1 bg-transparent outline-none text-sm" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} placeholder={UI_LABELS[lang].chatPlaceholder} /><button onClick={handleSend}><Send size={18} className="text-rose-400" /></button></div></div>
            </div>
          )}
        </>
      );
    };

    const AddEventModal = ({ onClose, onSave, lang }) => {
      const [time, setTime] = useState('');
      const [title, setTitle] = useState('');
      const handleSave = () => { if (!title) return; onSave(time || '00:00', title); };
      return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[80] flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-in">
            <div className="bg-rose-400 p-4 text-white font-bold text-center">{UI_LABELS[lang].addModalTitle}</div>
            <div className="p-5 space-y-4">
              <div><label className="block text-xs text-stone-500 mb-1">{UI_LABELS[lang].addModalTime}</label><input type="time" className="w-full border border-stone-200 rounded-lg p-2 text-stone-700 outline-none focus:ring-2 focus:ring-rose-300" value={time} onChange={(e) => setTime(e.target.value)} /></div>
              <div><label className="block text-xs text-stone-500 mb-1">{UI_LABELS[lang].addModalContent}</label><input type="text" className="w-full border border-stone-200 rounded-lg p-2 text-stone-700 outline-none focus:ring-2 focus:ring-rose-300" value={title} onChange={(e) => setTitle(e.target.value)} /></div>
              <div className="flex gap-3 pt-2"><button onClick={onClose} className="flex-1 py-2 rounded-lg bg-stone-100 text-stone-600 font-bold text-sm">{UI_LABELS[lang].addModalCancel}</button><button onClick={handleSave} className="flex-1 py-2 rounded-lg bg-rose-400 text-white font-bold text-sm shadow-md">{UI_LABELS[lang].addModalSubmit}</button></div>
            </div>
          </div>
        </div>
      );
    };

    const SplitBillModal = ({ onClose, lang }) => {
      const [partners, setPartners] = useState('');
      const [expenses, setExpenses] = useState([]);
      const [newExpense, setNewExpense] = useState({ payer: '', amount: '', description: '' });
      const [result, setResult] = useState(null);
      const [rate, setRate] = useState(0.023); 

      useEffect(() => {
        const saved = localStorage.getItem('seoul2025_split_bill');
        if (saved) {
          const data = JSON.parse(saved);
          setPartners(data.partners || '');
          setExpenses(data.expenses || []);
        }
      }, []);

      useEffect(() => {
        localStorage.setItem('seoul2025_split_bill', JSON.stringify({ partners, expenses }));
      }, [partners, expenses]);

      const handleAddExpense = () => {
        if (!newExpense.payer || !newExpense.amount) return;
        setExpenses([...expenses, { ...newExpense, id: Date.now() }]);
        setNewExpense({ ...newExpense, amount: '', description: '' });
      };

      const handleCalculate = () => {
        const people = partners.split(/[,，]/).map(p => p.trim()).filter(p => p);
        if (people.length < 2) return;
        const balances = {};
        people.forEach(p => balances[p] = 0);
        let totalSpent = 0;
        expenses.forEach(e => {
          if (balances[e.payer] !== undefined) {
            balances[e.payer] += parseFloat(e.amount);
            totalSpent += parseFloat(e.amount);
          }
        });
        const average = totalSpent / people.length;
        const debts = [];
        const details = people.map(p => ({ name: p, balance: balances[p] - average }));
        let debtors = details.filter(d => d.balance < -0.01).sort((a, b) => a.balance - b.balance);
        let creditors = details.filter(d => d.balance > 0.01).sort((a, b) => b.balance - a.balance);
        let i = 0, j = 0;
        while (i < debtors.length && j < creditors.length) {
          const debtor = debtors[i];
          const creditor = creditors[j];
          const amount = Math.min(Math.abs(debtor.balance), creditor.balance);
          debts.push({ from: debtor.name, to: creditor.name, amount: amount.toFixed(0) });
          debtor.balance += amount;
          creditor.balance -= amount;
          if (Math.abs(debtor.balance) < 0.01) i++;
          if (creditor.balance < 0.01) j++;
        }
        setResult(debts);
      };

      const peopleList = partners.split(/[,，]/).map(p => p.trim()).filter(p => p);
      const totalAmount = expenses.reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);
      const perPerson = peopleList.length > 0 ? totalAmount / peopleList.length : 0;

      return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[80] flex items-center justify-center p-4" onClick={onClose}>
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}>
            <div className="bg-[#FF7F50] p-4 text-white font-bold text-center flex justify-between items-center">
              <div className="flex items-center gap-2"><Banknote size={20} /> {UI_LABELS[lang].splitBill}</div>
              <button onClick={onClose}><X size={20} /></button>
            </div>
            <div className="p-4 overflow-y-auto flex-1 space-y-4">
              <div className="flex gap-2">
                  <div className="flex-1">
                    <label className="block text-xs text-stone-500 mb-1">旅行伙伴 (用逗號分隔)</label>
                    <input type="text" className="w-full border border-stone-200 rounded-lg p-2 text-sm" placeholder="小明, 小美" value={partners} onChange={e => setPartners(e.target.value)} />
                  </div>
                  <div className="w-24">
                     <label className="block text-xs text-stone-500 mb-1">{UI_LABELS[lang].rate} (KRW->TWD)</label>
                     <input type="number" step="0.001" className="w-full border border-stone-200 rounded-lg p-2 text-sm" value={rate} onChange={e => setRate(e.target.value)} />
                  </div>
              </div>
              
              <div className="bg-stone-50 p-3 rounded-xl flex justify-between items-center text-sm">
                  <div>
                      <div className="text-stone-500 text-xs">{UI_LABELS[lang].total}</div>
                      <div className="font-bold text-lg">₩{totalAmount.toLocaleString()} <span className="text-xs font-normal text-stone-400">(≈NT${(totalAmount * rate).toFixed(0)})</span></div>
                  </div>
                  <div className="text-right">
                      <div className="text-stone-500 text-xs">{UI_LABELS[lang].perPerson}</div>
                      <div className="font-bold text-lg">₩{perPerson.toFixed(0)} <span className="text-xs font-normal text-stone-400">(≈NT${(perPerson * rate).toFixed(0)})</span></div>
                  </div>
              </div>

              {peopleList.length > 0 && (
                <div className="bg-stone-50 p-3 rounded-xl space-y-2 border border-stone-100">
                  <div className="flex gap-2">
                    <select className="flex-1 border rounded-lg p-1.5 text-sm" value={newExpense.payer} onChange={e => setNewExpense({...newExpense, payer: e.target.value})}>
                      <option value="">誰付錢?</option>
                      {peopleList.map(p => <option key={p} value={p}>{p}</option>)}
                    </select>
                    <input type="number" className="w-24 border rounded-lg p-1.5 text-sm" placeholder="金額" value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} />
                  </div>
                  <div className="flex gap-2">
                    <input type="text" className="flex-1 border rounded-lg p-1.5 text-sm" placeholder="項目 (可選)" value={newExpense.description} onChange={e => setNewExpense({...newExpense, description: e.target.value})} />
                    <button onClick={handleAddExpense} className="bg-[#FF7F50] text-white px-3 rounded-lg text-sm font-bold">+</button>
                  </div>
                </div>
              )}
              <div className="space-y-1 max-h-40 overflow-y-auto">
                {expenses.map((ex, idx) => (
                  <div key={ex.id} className="flex justify-between text-sm p-2 bg-white border rounded-lg items-center">
                    <span><span className="font-bold text-orange-600">{ex.payer}</span> 付了 {ex.amount} {ex.description && `(${ex.description})`}</span>
                    <button onClick={() => setExpenses(expenses.filter(e => e.id !== ex.id))} className="text-stone-400 hover:text-red-400"><Trash2 size={14}/></button>
                  </div>
                ))}
              </div>
              {result && (
                <div className="bg-orange-50 p-3 rounded-xl border border-orange-100">
                  <h4 className="font-bold text-orange-800 text-sm mb-2">結算結果：</h4>
                  {result.length === 0 ? <p className="text-sm text-orange-600">目前沒有人需要付錢給誰</p> : (
                    <ul className="space-y-1 text-sm text-orange-700">
                      {result.map((r, i) => <li key={i}><span className="font-bold">{r.from}</span> 給 <span className="font-bold">{r.to}</span>: ₩{r.amount} <span className="text-xs text-stone-400">(NT${(r.amount * rate).toFixed(0)})</span></li>)}
                    </ul>
                  )}
                </div>
              )}
            </div>
            <div className="p-4 border-t">
              <button onClick={handleCalculate} className="w-full bg-[#FF7F50] text-white py-3 rounded-xl font-bold shadow-md hover:bg-orange-500">計算分帳</button>
            </div>
          </div>
        </div>
      );
    };

    // --- Settings Modal ---
    const SettingsModal = ({ onClose, lang }) => {
        const [apiKey, setApiKey] = useState('');
        
        useEffect(() => {
            const savedKey = localStorage.getItem('gemini_api_key') || '';
            setApiKey(savedKey);
        }, []);

        const handleSave = () => {
            localStorage.setItem('gemini_api_key', apiKey.trim());
            alert('API Key 已儲存！');
            onClose();
        };

        return (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[90] flex items-center justify-center p-4" onClick={onClose}>
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-in" onClick={e => e.stopPropagation()}>
                    <div className="bg-stone-700 p-4 text-white font-bold text-center flex justify-between items-center">
                        <div className="flex items-center gap-2"><Settings size={20} /> {UI_LABELS[lang].settings}</div>
                        <button onClick={onClose}><X size={20} /></button>
                    </div>
                    <div className="p-5 space-y-4">
                        <div>
                            <label className="block text-xs text-stone-500 mb-1">Google Gemini API Key</label>
                            <input 
                                type="password" 
                                className="w-full border border-stone-200 rounded-lg p-2 text-stone-700 outline-none focus:ring-2 focus:ring-stone-400 font-mono text-sm" 
                                placeholder={UI_LABELS[lang].apiKeyPlaceholder}
                                value={apiKey} 
                                onChange={(e) => setApiKey(e.target.value)} 
                            />
                            <p className="text-[10px] text-stone-400 mt-1">Key 將儲存於您的瀏覽器中，不會上傳至其他伺服器。</p>
                        </div>
                        <button onClick={handleSave} className="w-full bg-stone-700 text-white py-2 rounded-lg font-bold shadow-md hover:bg-stone-800 transition-colors">
                            {UI_LABELS[lang].addModalSubmit}
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    const loadData = (language) => {
        const key = `seoul_trip_2025_${language}`;
        try { 
          const saved = localStorage.getItem(key); 
          if (saved) {
            const parsed = JSON.parse(saved);
            if (parsed && parsed[0] && parsed[0].activities) {
               parsed[0].activities.forEach(act => {
                  if (act.items && act.items.length > 0 && typeof act.items[0] === 'string') {
                     act.items = act.items.map(text => ({ text, checked: false }));
                  }
               });
            }
            return parsed; 
          }
        } catch (e) { console.error("Failed to load itinerary", e); }
        return getInitialItinerary(language);
    };

    function App() {
      const [lang, setLang] = useState('ZH');
      const [activeDay, setActiveDay] = useState(0);
      const [itinerary, setItinerary] = useState(() => loadData('ZH'));
      const [selectedActivity, setSelectedActivity] = useState(null);
      const [showAddEventModal, setShowAddEventModal] = useState(false);
      const [showSplitBill, setShowSplitBill] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      
      const touchStartX = useRef(null);
      const onTouchStart = e => touchStartX.current = e.targetTouches[0].clientX;
      const onTouchEnd = e => { if (!touchStartX.current) return; const diff = touchStartX.current - e.changedTouches[0].clientX; if (diff > 50 && activeDay < itinerary.length - 1) setActiveDay(p => p + 1); if (diff < -50 && activeDay > 0) setActiveDay(p => p - 1); };
      const getInitialActiveDay = () => { const now = new Date(); const year = now.getFullYear(); const month = now.getMonth(); const date = now.getDate(); if (year === 2025 && month === 11 && date >= 18 && date <= 24) return date - 18 + 1; return 0; };

      useEffect(() => { setActiveDay(getInitialActiveDay()); }, []);
      useEffect(() => { const key = `seoul_trip_2025_${lang}`; localStorage.setItem(key, JSON.stringify(itinerary)); }, [itinerary, lang]);

      const handleLangChange = (newLang) => {
          setLang(newLang);
          const savedData = loadData(newLang);
          setItinerary(savedData);
      };

      const forceSave = () => {
          const key = `seoul_trip_2025_${lang}`; 
          localStorage.setItem(key, JSON.stringify(itinerary));
          alert('行程已儲存！');
      };

      const updateActivity = (d, a, f, v) => { 
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[d] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[a] };
        newActivity[f] = v;
        newActivities[a] = newActivity;
        newDay.activities = newActivities;
        newItinerary[d] = newDay;
        setItinerary(newItinerary); 
      };
      
      const updateTheme = (d, v) => { 
        const newItinerary = [...itinerary]; 
        newItinerary[d] = { ...newItinerary[d], theme: v };
        setItinerary(newItinerary); 
      };
      
      const handleSaveNewEvent = (time, title) => {
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[activeDay] };
        const newActivities = [...newDay.activities];
        newActivities.push({ time: time, title: title, type: 'default', desc: '點擊編輯內容', location: title, transport: '' });
        newActivities.sort((a, b) => { const tA = a.time || "99:99"; const tB = b.time || "99:99"; return tA.localeCompare(tB); });
        newDay.activities = newActivities;
        newItinerary[activeDay] = newDay;
        setItinerary(newItinerary);
        setShowAddEventModal(false);
      };
      
      const toggleCheck = (dayIdx, actIdx, itemIdx) => {
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[dayIdx] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[actIdx] };
        const newItems = [...newActivity.items];
        newItems[itemIdx] = { ...newItems[itemIdx], checked: !newItems[itemIdx].checked };
        newActivity.items = newItems;
        newActivities[actIdx] = newActivity;
        newDay.activities = newActivities;
        newItinerary[dayIdx] = newDay;
        setItinerary(newItinerary);
      };

      const updateChecklistItemText = (dayIdx, actIdx, itemIdx, text) => {
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[dayIdx] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[actIdx] };
        const newItems = [...newActivity.items];
        newItems[itemIdx] = { ...newItems[itemIdx], text: text };
        newActivity.items = newItems;
        newActivities[actIdx] = newActivity;
        newDay.activities = newActivities;
        newItinerary[dayIdx] = newDay;
        setItinerary(newItinerary);
      };

      const addChecklistItem = (dayIdx, actIdx) => {
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[dayIdx] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[actIdx] };
        const newItems = [...newActivity.items];
        newItems.push({ text: '點擊編輯新項目', checked: false });
        newActivity.items = newItems;
        newActivities[actIdx] = newActivity;
        newDay.activities = newActivities;
        newItinerary[dayIdx] = newDay;
        setItinerary(newItinerary);
      };

      const deleteChecklistItem = (dayIdx, actIdx, itemIdx) => {
        if (!confirm('確定刪除此項目？')) return;
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[dayIdx] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[actIdx] };
        const newItems = [...newActivity.items];
        newItems.splice(itemIdx, 1);
        newActivity.items = newItems;
        newActivities[actIdx] = newActivity;
        newDay.activities = newActivities;
        newItinerary[dayIdx] = newDay;
        setItinerary(newItinerary);
      };

      const currentDay = itinerary[activeDay];

      return (
        <div className="min-h-screen bg-[#fdf8f9] font-sans pb-20 relative">
          <header className="sticky top-0 z-40 bg-[#fdf8f9]/90 backdrop-blur-lg border-b border-rose-100 shadow-sm">
            <div className="max-w-3xl mx-auto px-4 pt-3 pb-0"> 
              <div className="flex flex-row justify-between items-start gap-2 mb-1">
                <div className="flex flex-col items-start gap-1 min-w-0">
                  <h1 className="text-xl md:text-3xl font-bold text-rose-950 tracking-tight truncate w-full">{UI_LABELS[lang].title}</h1>
                  {UI_LABELS[lang].subtitle && <span className="text-xs md:text-sm text-rose-700/70 truncate w-full">{UI_LABELS[lang].subtitle}</span>}
                  <RealTimeDateDisplay />
                </div>
                <div className="flex flex-col items-end gap-2 shrink-0">
                   <TimeWeatherWidget />
                   <div className="flex items-center gap-2">
                     <button onClick={() => setShowSettings(true)} className="p-1.5 bg-stone-100 text-stone-600 rounded-full hover:bg-stone-200 transition-colors"><Settings size={16} /></button>
                     <button onClick={() => setShowSplitBill(true)} className="p-1.5 bg-[#FF7F50] text-white rounded-full hover:bg-[#ff6b35] transition-colors"><Banknote size={16} /></button>
                     <div className="flex bg-rose-100/50 p-1 rounded-full">{Object.keys(LANGUAGES).map(l => <button key={l} onClick={() => handleLangChange(l)} className={`px-2 py-1 rounded-full text-[10px] font-bold transition-all ${lang === l ? 'bg-white text-rose-600 shadow-sm' : 'text-rose-400'}`}>{l}</button>)}</div>
                   </div>
                </div>
              </div>
            </div>
            <div className="max-w-3xl mx-auto px-2 overflow-x-auto no-scrollbar pb-2">
              <div className="flex space-x-2 py-2 min-w-max">
                {itinerary.map((day, idx) => (
                  <button key={idx} onClick={() => setActiveDay(idx)} className={`flex flex-col items-center min-w-[4rem] py-2 px-2 rounded-2xl border transition-all ${activeDay === idx ? 'bg-rose-400 border-rose-400 text-white shadow-md scale-105' : 'bg-white border-rose-100 text-stone-400'}`}>
                    <span className="text-[10px] font-bold opacity-80">{UI_LABELS[lang].days[idx]}</span>
                    <span className="text-sm font-bold mt-0.5">{day.date.split(' ')[0]}</span>
                  </button>
                ))}
              </div>
            </div>
          </header>
          <main className="max-w-3xl mx-auto px-4 py-4 pb-20 relative min-h-[60vh]" onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
            <div key={activeDay} className="animate-fade-in">
              <div className="mb-6 pl-2 border-l-4 border-rose-300 flex justify-between items-center">
                <div>
                  <div className="text-stone-400 text-sm font-medium mb-0.5">{currentDay.date}</div>
                  <h2 className="text-xl font-bold text-stone-800"><EditableText text={currentDay.theme} onSave={(v) => updateTheme(activeDay, v)} /></h2>
                </div>
                <div className="flex gap-2">
                  <button onClick={forceSave} className="flex items-center gap-1 text-xs font-bold text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full shadow-sm hover:bg-emerald-100 transition-colors shrink-0"><Save size={14} /><span>儲存</span></button>
                  {activeDay !== 0 && activeDay !== 1 && activeDay !== 7 && (
                    <button onClick={() => setShowAddEventModal(true)} className="flex items-center gap-1 text-xs font-bold text-white bg-rose-400 px-3 py-1.5 rounded-full shadow-sm hover:bg-rose-500 transition-colors shrink-0"><Plus size={14} /><span>{UI_LABELS[lang].addEvent}</span></button>
                  )}
                </div>
              </div>
              <div className="relative space-y-6 pl-4 border-l-2 border-rose-100 ml-3">
                {currentDay.activities.map((item, i) => (
                  <div key={i} className="relative group">
                    <div className={`bg-white rounded-2xl p-4 shadow-sm border hover:shadow-md transition-shadow ${item.type.includes('warning') ? 'border-amber-200 bg-amber-50/30' : (item.type === 'checklist' ? 'border-emerald-100' : (item.type === 'ses' ? 'border-blue-200 bg-blue-50/30' : 'border-stone-100'))}`}>
                      {item.type === 'checklist' || item.type.includes('warning') || item.type === 'doc' || item.type === 'ses' ? (
                        <div>
                           <div className="flex items-center gap-2 mb-2">
                              <h3 className={`font-bold text-lg ${item.type.includes('warning') ? 'text-amber-700' : (item.type === 'ses' ? 'text-blue-800' : 'text-stone-800')}`}>{item.title}</h3>
                           </div>
                           <p className="text-sm text-stone-500 mb-3">{item.desc}</p>
                           <ul className="space-y-2">
                             {item.items && item.items.map((subItem, subIdx) => (
                               <li key={subIdx} className="flex items-start gap-2 text-sm text-stone-700 group/item">
                                  {item.type !== 'ses' && (
                                    <input 
                                      type="checkbox" 
                                      checked={subItem.checked || false}
                                      onChange={() => toggleCheck(activeDay, i, subIdx)}
                                      className={`mt-1 w-4 h-4 rounded border-gray-300 focus:ring-rose-400 cursor-pointer ${item.type.includes('warning') ? 'accent-amber-500' : 'accent-emerald-500'}`} 
                                    />
                                  )}
                                  <span className={`flex-1 break-words ${item.type === 'ses' ? 'text-blue-700 font-medium' : (subItem.checked ? 'line-through text-stone-400' : '')}`}>
                                    {item.type === 'ses' ? subItem.text : (
                                      <EditableText 
                                        text={subItem.text} 
                                        onSave={(val) => updateChecklistItemText(activeDay, i, subIdx, val)} 
                                        className="w-full"
                                      />
                                    )}
                                  </span>
                                  {item.type !== 'ses' && (
                                    <button 
                                      onClick={() => deleteChecklistItem(activeDay, i, subIdx)}
                                      className="opacity-0 group-hover/item:opacity-100 text-stone-400 hover:text-red-400 transition-opacity"
                                    >
                                      <Trash2 size={14} />
                                    </button>
                                  )}
                               </li>
                             ))}
                           </ul>
                           {item.type !== 'ses' && (
                             <button 
                               onClick={() => addChecklistItem(activeDay, i)}
                               className="mt-3 text-xs flex items-center gap-1 text-stone-400 hover:text-rose-500 transition-colors"
                             >
                               <Plus size={12} /> {UI_LABELS[lang].addItem}
                             </button>
                           )}
                        </div>
                      ) : (
                        <div>
                          <div className="flex justify-between items-center mb-2 pb-2 border-b border-stone-50">
                            <div className="flex items-center gap-2 overflow-hidden">
                               <div className="bg-rose-100 text-rose-500 rounded-full p-1 shrink-0">
                                 <IconType type={item.type} className="w-3 h-3" />
                               </div>
                               <span className="font-mono text-rose-500 font-bold bg-rose-50 px-1.5 rounded text-sm shrink-0"><EditableText text={item.time} onSave={(v) => updateActivity(activeDay, i, 'time', v)} /></span>
                               <h3 className="font-bold text-stone-800 truncate"><EditableText text={item.title} onSave={(v) => updateActivity(activeDay, i, 'title', v)} /></h3>
                            </div>
                            <ActivityWeather day={activeDay} index={i} location={item.location} />
                          </div>
                          <div className="text-stone-600 text-sm mb-3 leading-relaxed"><EditableText multiline text={item.desc} onSave={(v) => updateActivity(activeDay, i, 'desc', v)} /></div>
                          <button onClick={() => setSelectedActivity(item)} className="flex items-center gap-1 text-[10px] font-bold text-rose-500 bg-rose-50 px-2 py-1 rounded hover:bg-rose-100 transition-colors w-fit mb-2"><Sparkles size={10} />{UI_LABELS[lang].genPhrases}</button>
                          {(item.location || item.transport || item.duration) && (
                            <div className="mt-2 flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-stone-500">
                              {item.location && (
                                <a 
                                  href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`} 
                                  target="_blank" 
                                  rel="noopener noreferrer"
                                  className="flex items-center gap-1 text-rose-400 hover:text-rose-600 transition-colors group/map shrink-0"
                                  onClick={(e) => e.stopPropagation()}
                                >
                                  <MapPin size={11} className="group-hover/map:scale-110 transition-transform" />
                                  <span className="border-b border-transparent group-hover/map:border-rose-400">{item.location}</span>
                                </a>
                              )}
                              {item.transport && <TransportDisplay text={item.transport} />}
                            </div>
                          )}
                        </div>
                      )}

                    </div>
                  </div>
                ))}
              </div>
            </div>
          </main>

          <AIChatWidget itinerary={itinerary} lang={lang} />
          {selectedActivity && <MagicPhraseModal activity={selectedActivity} lang={lang} onClose={() => setSelectedActivity(null)} />}
          {showAddEventModal && <AddEventModal onClose={() => setShowAddEventModal(false)} onSave={handleSaveNewEvent} lang={lang} />}
          {showSplitBill && <SplitBillModal onClose={() => setShowSplitBill(false)} lang={lang} />}
          {showSettings && <SettingsModal onClose={() => setShowSettings(false)} lang={lang} />}
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
