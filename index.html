<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2025 Seoul Travel Guide</title>
  
  <!-- PWA Ë®≠ÂÆö -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Seoul2025">
  <meta name="application-name" content="Seoul2025">
  <meta name="theme-color" content="#fdf8f9">
  <meta name="mobile-web-app-capable" content="yes">

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23fb7185' rx='100'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='120' fill='white'%3ESEOUL%3C/text%3E%3Ctext x='50%25' y='70%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='80' fill='white'%3E2025%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' fill='%23fb7185' rx='100'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='120' fill='white'%3ESEOUL%3C/text%3E%3Ctext x='50%25' y='70%25' dominant-baseline='middle' text-anchor='middle' font-family='sans-serif' font-weight='bold' font-size='80' fill='white'%3E2025%3C/text%3E%3C/svg%3E">
  
  <link rel="manifest" href='data:application/manifest+json,{"name":"Seoul2025","short_name":"Seoul2025","start_url":".","display":"standalone","background_color":"#fdf8f9","theme_color":"#fdf8f9","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27512%27 height=%27512%27 viewBox=%270 0 512 512%27%3E%3Crect width=%27512%27 height=%27512%27 fill=%27%23fb7185%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27bold%27 font-size=%27120%27 fill=%27white%27%3ESEOUL%3C/text%3E%3Ctext x=%2750%25%27 y=%2770%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27bold%27 font-size=%2780%27 fill=%27white%27%3E2025%3C/text%3E%3C/svg%3E","sizes":"192x192","type":"image/svg+xml","purpose":"any maskable"},{"src":"data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27512%27 height=%27512%27 viewBox=%270 0 512 512%27%3E%3Crect width=%27512%27 height=%27512%27 fill=%27%23fb7185%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27bold%27 font-size=%27120%27 fill=%27white%27%3ESEOUL%3C/text%3E%3Ctext x=%2750%25%27 y=%2770%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-family=%27sans-serif%27 font-weight=%27bold%27 font-size=%2780%27 fill=%27white%27%3E2025%3C/text%3E%3C/svg%3E","sizes":"512x512","type":"image/svg+xml","purpose":"any maskable"}]}'>

  <!-- ËºâÂÖ• Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- ËºâÂÖ• Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body { font-family: sans-serif; background-color: #fdf8f9; user-select: none; -webkit-user-select: none; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes fade-in {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React Á®ãÂºèÁ¢º -->
  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    import { 
      Plane, Train, Bus, MapPin, Music, Coffee, Camera, Moon, Sun, Cloud, 
      Snowflake, Clock, Edit3, Globe, ChevronRight, Navigation, Footprints, 
      Utensils, ShoppingBag, BedDouble, Ticket, Home, Ship, Car, Sparkles, 
      MessageCircle, X, Send, Loader2, Languages, Bot, AlertTriangle, Volume2,
      ClipboardCheck, FileText, AlertCircle, Briefcase, Scan, CloudRain, Mic, Wand2, Plus, Save, Check, Trash2, Banknote, Settings
    } from 'https://esm.sh/lucide-react@0.263.1';

    // --- Ë®≠ÂÆö ---
    const LANGUAGES = { ZH: 'ZH', KR: 'KR', EN: 'EN', JP: 'JP' };
    const UI_LABELS = {
      ZH: { title: '2025 È¶ñÁàæ‰πãÊóÖ', subtitle: 'Âú≠Ë≥¢ÊºîÂî±ÊúÉ„ÉªÂÜ¨Êó•È¶ñÁàæ', editTip: 'ÈªûÊìäÊñáÂ≠óÂç≥ÂèØÁ∑®ËºØ', days: ['Ê∫ñÂÇô', 'Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'], transport: '‰∫§ÈÄö', estTime: 'ÊôÇÈñì', location: 'Âú∞Èªû', aiChat: 'AI Èö®Ë∫´Â∞éÈÅä', genPhrases: 'ÈüìË™ûÂπ´Êâã', phrasesTitle: '‚ú® ÊÉÖÂ¢ÉÈüìË™ûÂ∞èÂπ´Êâã', chatPlaceholder: 'ÂïèÂïè AI...', close: 'ÈóúÈñâ', fallbackMsg: 'AI ÈÄ£Á∑öÁï∞Â∏∏', addEvent: 'Êñ∞Â¢ûË°åÁ®ã', addModalTitle: 'Êñ∞Â¢ûË°åÁ®ã', addModalTime: 'ÊôÇÈñì (24Â∞èÊôÇÂà∂)', addModalContent: 'Âú∞Èªû / Ê¥ªÂãïÂÖßÂÆπ', addModalSubmit: 'ÂÑ≤Â≠ò‰∏¶ÊéíÂ∫è', addModalCancel: 'ÂèñÊ∂à', addItem: 'Êñ∞Â¢ûÈ†ÖÁõÆ', splitBill: 'ÂàÜÂ∏≥', settings: 'Ë®≠ÂÆö', apiKeyPlaceholder: 'Ëº∏ÂÖ• Gemini API Key' },
      KR: { title: '2025 ÏÑúÏö∏ Ïó¨Ìñâ', subtitle: 'Í∑úÌòÑ ÏΩòÏÑúÌä∏ ‚Ä¢ Í≤®Ïö∏ ÏÑúÏö∏', editTip: 'ÌÅ¥Î¶≠ÌïòÏó¨ Ìé∏Ïßë', days: ['Ï§ÄÎπÑ', '1ÏùºÏ∞®', '2ÏùºÏ∞®', '3ÏùºÏ∞®', '4ÏùºÏ∞®', '5ÏùºÏ∞®', '6ÏùºÏ∞®', '7ÏùºÏ∞®'], transport: 'ÍµêÌÜµ', estTime: 'ÏãúÍ∞Ñ', location: 'Ïû•ÏÜå', aiChat: 'AI Í∞ÄÏù¥Îìú', genPhrases: 'ÌïúÍµ≠Ïñ¥ ÎèÑÏö∞ÎØ∏', phrasesTitle: '‚ú® ÌïúÍµ≠Ïñ¥', chatPlaceholder: 'ÏßàÎ¨∏...', close: 'Îã´Í∏∞', fallbackMsg: 'AI Ïò§Î•ò', addEvent: 'ÏùºÏ†ï Ï∂îÍ∞Ä', addModalTitle: 'Ï∂îÍ∞Ä', addModalTime: 'ÏãúÍ∞Ñ', addModalContent: 'ÎÇ¥Ïö©', addModalSubmit: 'Ï†ÄÏû•', addModalCancel: 'Ï∑®ÏÜå', addItem: 'Ìï≠Î™© Ï∂îÍ∞Ä', splitBill: 'Ï†ïÏÇ∞', settings: 'ÏÑ§Ï†ï', apiKeyPlaceholder: 'API Key ÏûÖÎ†•' },
      EN: { title: 'Seoul Trip 2025', subtitle: 'Kyuhyun Concert ‚Ä¢ Winter Seoul', editTip: 'Click to edit', days: ['Prep', 'Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'], transport: 'Transport', estTime: 'Time', location: 'Loc', aiChat: 'AI Guide', genPhrases: 'Helper', phrasesTitle: '‚ú® Phrases', chatPlaceholder: 'Ask AI...', close: 'Close', fallbackMsg: 'AI Offline', addEvent: 'Add', addModalTitle: 'Add Event', addModalTime: 'Time', addModalContent: 'Content', addModalSubmit: 'Save', addModalCancel: 'Cancel', addItem: 'Add Item', splitBill: 'Split Bill', settings: 'Settings', apiKeyPlaceholder: 'Enter API Key' },
      JP: { title: '2025 „ÇΩ„Ç¶„É´ÊóÖË°å', subtitle: '„Ç≠„É•„Éí„Éß„É≥„Ç≥„É≥„Çµ„Éº„Éà„ÉªÂÜ¨„ÅÆ„ÇΩ„Ç¶„É´', editTip: '„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Á∑®ÈõÜ', days: ['Ê∫ñÂÇô', '1Êó•ÁõÆ', '2Êó•ÁõÆ', '3Êó•ÁõÆ', '4Êó•ÁõÆ', '5Êó•ÁõÆ', '6Êó•ÁõÆ', '7Êó•ÁõÆ'], transport: '‰∫§ÈÄö', estTime: 'ÊôÇÈñì', location: 'Â†¥ÊâÄ', aiChat: 'AI „Ç¨„Ç§„Éâ', genPhrases: 'ÈüìÂõΩË™û„Éò„É´„Éó', phrasesTitle: '‚ú® ÈüìÂõΩË™û', chatPlaceholder: 'Ë≥™Âïè...', close: 'Èñâ„Åò„Çã', fallbackMsg: 'AI„Ç®„É©„Éº', addEvent: 'ËøΩÂä†', addModalTitle: 'ËøΩÂä†', addModalTime: 'ÊôÇÈñì', addModalContent: 'ÂÜÖÂÆπ', addModalSubmit: '‰øùÂ≠ò', addModalCancel: '„Ç≠„É£„É≥„Çª„É´', addItem: 'ËøΩÂä†', splitBill: 'Ââ≤„ÇäÂãò', settings: 'Ë®≠ÂÆö', apiKeyPlaceholder: 'API„Ç≠„Éº„ÇíÂÖ•Âäõ' }
    };

    const FALLBACK_PHRASES_BY_TYPE = {
      food: [{ korean: 'Î©îÎâ¥Ìåê Ï¢Ä Ï£ºÏÑ∏Ïöî', pronunciation: 'Menyupan jom juseyo', meaning: 'Ë´ãÁµ¶ÊàëËèúÂñÆ' }, { korean: 'Ïù¥Í±∞ Ï£ºÏÑ∏Ïöî', pronunciation: 'Ige juseyo', meaning: 'Ë´ãÁµ¶ÊàëÈÄôÂÄã' }, { korean: 'Í≥ÑÏÇ∞Ìï¥ Ï£ºÏÑ∏Ïöî', pronunciation: 'Gyesanhae juseyo', meaning: 'Ë´ãÁµêÂ∏≥' }],
      shopping: [{ korean: 'Ïù¥Í±∞ ÏñºÎßàÏòàÏöî?', pronunciation: 'Ige eolmayeyo?', meaning: 'ÈÄôÂÄãÂ§öÂ∞ëÈå¢?' }, { korean: 'ÍπéÏïÑÏ£ºÏÑ∏Ïöî', pronunciation: 'Kkakkajuseyo', meaning: 'Ë´ãÁÆó‰æøÂÆú‰∏ÄÈªû' }, { korean: 'ÏûÖÏñ¥Î¥êÎèÑ ÎèºÏöî?', pronunciation: 'Ibeobwado dwaeyo?', meaning: 'ÂèØ‰ª•Ë©¶Á©øÂóé?' }],
      transport: [{ korean: 'Ïù¥ Î≤ÑÏä§ Î™ÖÎèô Í∞ÄÎÇòÏöî?', pronunciation: 'I beoseu Myeongdong ganayo?', meaning: 'ÈÄôÁè≠ÂÖ¨ËªäÂéªÊòéÊ¥ûÂóé?' }, { korean: 'Ïó¨Í∏∞ÏÑú ÎÇ¥Î†§Ï£ºÏÑ∏Ïöî', pronunciation: 'Yeogiseo naeryeojuseyo', meaning: 'Ë´ãÂú®ÈÄôË£°ËÆìÊàë‰∏ãËªä' }],
      default: [{ korean: 'ÏïàÎÖïÌïòÏÑ∏Ïöî', pronunciation: 'Annyeonghaseyo', meaning: '‰Ω†Â•Ω' }, { korean: 'Í∞êÏÇ¨Ìï©ÎãàÎã§', pronunciation: 'Gamsahamnida', meaning: 'Ë¨ùË¨ù' }, { korean: 'ÌôîÏû•Ïã§ Ïñ¥ÎîîÏòàÏöî?', pronunciation: 'Hwajangsil eodiyeyo?', meaning: 'Ê¥óÊâãÈñìÂú®Âì™Ë£°?' }]
    };

    // --- Âú∞ÈêµÈ°èËâ≤ ---
    const SUBWAY_COLORS = {
      '1': '#0052A4', '2': '#00A84D', '3': '#EF7C1C', '4': '#00A5DE',
      '5': '#996CAC', '6': '#CD7C2F', '7': '#747F00', '8': '#E6186C', '9': '#BDB092',
      'AREX': '#0090D2', 'A': '#0090D2', 'K': '#77C4A3', 'B': '#E7E727', 'S': '#A71E31'
    };

    // --- API ---
    const getApiKeyFromStorage = () => localStorage.getItem('gemini_api_key') || "";

    const callGeminiAPI = async (prompt, systemInstruction = "") => {
      const apiKey = getApiKeyFromStorage();
      if (!apiKey) return { success: false, error: "Please set API Key in Settings" };
      
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
      
      for (let i = 0; i < 2; i++) {
        try {
          const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: systemInstruction + "\n\n" + prompt }] }] }) });
          if (!response.ok) throw new Error(response.statusText);
          const data = await response.json();
          return { success: true, data: data.candidates?.[0]?.content?.parts?.[0]?.text };
        } catch (e) { await new Promise(r => setTimeout(r, 1000)); }
      }
      return { success: false, error: "Failed" };
    };

    // --- Data Helper ---
    const toObj = (item) => (typeof item === 'string' ? { text: item, checked: false } : item);

    // --- Data ---
    const getInitialItinerary = (lang) => {
      const checklist = ['Ë≠∑ÁÖß (ÊïàÊúü6ÂÄãÊúà‰ª•‰∏ä) / EsimÂç°', 'Èå¢ÂåÖÊï¥ÁêÜ (ÁèæÈáë/‰ø°Áî®Âç°/Ê©üÁ•®)', 'ÊâãÊ©üÂÖÖÈõªÊùø / ÊâãÈå∂ÂÖÖÈõªÁ∑ö / ËΩâÊé•È†≠(4.8mm)', 'ËÄ≥Ê©ü / Ë°åÂãïÈõªÊ∫ê (ÈúÄÊâãÊèê)', 'Ê¢≥Ê¥óÂà∑ÁâôÁî®ÂìÅ / ‰øùÈ§äÂèäÂç∏Â¶ùÁî®ÂìÅ', 'Ë≠∑È´ÆÊï¥È´ÆÊ¢≥Â≠ê / ÁúºÈè°', 'ÊØèÊó•Ë°£Êúç / ÂÖßË°£Ë§≤ / Ë•™Â≠ê', 'Áù°Ë°£Ë§≤ / ÊãñÈûã / Ë≠∑ËÜù', 'ÁÜ±Ê∞¥Áì∂ / ‰øùÊöñË°£Áâ©', '‰∏ÄËà¨Ëó•ÂìÅ / Âè£ÁΩ©'].map(toObj);
      const sesItems = ['Âú∞ÈªûÔºöT1 ÂÖ•Â¢ÉÂØ©Êü•Â§ßÂª≥ F ÂçÄ', 'ÊôÇÈñìÔºö07:00 - 18:00', 'ÊµÅÁ®ãÔºö‰∏ãÊ©ü -> Êâæ F ÂçÄÁôªË®ò‰∏≠ÂøÉ -> ÊãçÁÖß/ÊåáÁ¥ã -> Ëá™ÂãïÈÄöÈóú', 'ÂÇôÊ°àÔºöËã•ÈåØÈÅéÔºåÂÖ•Â¢ÉÂæåËá≥ 3 Ê®ìÂá∫Â¢ÉÂ§ßÂª≥ G ÂçÄËæ¶ÁêÜ'].map(toObj);
      
      const day0_ZH = {
        day: 0, date: 'Âá∫ÁôºÂâç', theme: 'Ë°åÂâçÊ∫ñÂÇô & SeSÁî≥Ë´ã',
        activities: [
          { title: 'ÂøÖÂÇôË°åÊùéÊ∏ÖÂñÆ', type: 'checklist', desc: 'Âá∫ÁôºÂâçË´ãÂãôÂøÖÁ¢∫Ë™ç‰ª•‰∏ãÁâ©ÂìÅÔºö', items: checklist },
          { title: '‰ªÅÂ∑ùÊ©üÂ†¥ SeS Ëá™ÂãïÈÄöÈóúÁî≥Ë´ã', type: 'ses', desc: 'Âè∞ÁÅ£ÊóÖÂÆ¢ÂèØÊñº T1 ÂÖ•Â¢ÉÂØ©Êü• F ÂçÄÁõ¥Êé•Ëæ¶ÁêÜ„ÄÇ', items: sesItems },
          { title: '‰∏çÂèØÊâãÊèê / ÂøÖÈ†àË®óÈÅã', type: 'warning', desc: 'Ê∂≤È´î > 100ml, ÂàÄÂâ™Â∑•ÂÖ∑„ÄÇ', items: ['Â§ßÁì∂ÂåñÂ¶ùÊ∞¥/‰π≥Ê∂≤', '‰øÆÁúâÂàÄ/ÊåáÁî≤Ââ™', 'ËÖ≥Êû∂/Ëá™ÊãçÊ£í (ÁÆ°Âæë>1cm, Èï∑>60cm)'].map(toObj) },
          { title: '‰∏çÂèØË®óÈÅã / ÂøÖÈ†àÊâãÊèê', type: 'warning_red', desc: 'ÈõªÊ±†È°ûÂãôÂøÖÈö®Ë∫´ÊîúÂ∏∂ÔºÅ', items: ['Ë°åÂãïÈõªÊ∫ê', 'Èã∞ÈõªÊ±†', 'Á≠ÜÈõª/Âπ≥Êùø', 'ÈõªÂ≠êËè∏'].map(toObj) },
          { title: 'ÊóÖË°åÊñá‰ª∂', type: 'doc', desc: 'Âª∫Ë≠∞ÂÇô‰ªΩÔºö', items: ['Q-CODE', 'Ë®ÇÊàøÁ¢∫Ë™çÂñÆ', 'ÊºîÂî±ÊúÉÈñÄÁ•®', '‰øùÈö™ÂñÆ'].map(toObj) }
        ]
      };
      // Simplified placeholders for other languages Day 0
      const day0_KR = JSON.parse(JSON.stringify(day0_ZH));
      const day0_EN = JSON.parse(JSON.stringify(day0_ZH));
      const day0_JP = JSON.parse(JSON.stringify(day0_ZH));

      const days_ZH = [
          { day: 1, date: '12/18 (Âõõ)', theme: 'ÊäµÈÅîÈ¶ñÁàæ & È£ØÂ∫óÂÖ•‰Ωè', activities: [{ time: '12:00', title: 'ÂæûÊ∫´ÊöñÁöÑÂÆ∂Âá∫Áôº', type: 'car', desc: 'È†êÁ¥ÑËÇØÈ©õÊ©üÂ†¥Êé•ÈÄÅËá≥Ê°ÉÂúíÊ©üÂ†¥„ÄÇ', location: 'Home', transport: 'Â∞àËªä' }, { time: '15:15', title: 'Èï∑Ê¶Æ BR160 Ëµ∑È£õ', type: 'flight', desc: 'TPE (T2) -> ICN', location: 'TPE Airport' }, { time: '18:45', title: 'ÊäµÈÅî‰ªÅÂ∑ùÊ©üÂ†¥ & ÂÖ•Â¢É', type: 'arrival', desc: 'ÂÖ•Â¢É„ÄÅÈ†òË°åÊùé„ÄÅË≤∑ T-Money„ÄÇ', location: 'ICN Airport' }, { time: '20:00', title: 'ÂâçÂæÄ Wecostay', type: 'bus', desc: 'Êê≠‰πò 6015 Â∑¥Â£´Ëá≥Âø†Ê≠¶Ë∑ØÁ´ô„ÄÇ', info: 'Ë≤ªÁî®: 17,000 KRW', customPhrases: [{ korean: 'G3 Ìò∏ÌÖîÏóêÏÑú ÎÇ¥Î†§Ï£ºÏÑ∏Ïöî', pronunciation: 'G3 Hotel-eseo naeryeojuseyo', meaning: 'ÊàëÂÄëÂà∞ G3 Hotel ‰∏ãËªä' }], transport: '‰ªÅÂ∑ùÊ©üÂ†¥ 5B/11B Á´ôÁâåÊê≠‰πò„Äê6015 Ê©üÂ†¥Â∑¥Â£´„Äë(ÂæÄÊòéÊ¥ûÊñπÂêë)ÔºåÁ∂ìÈÅé 3 Á´ô(Á¥Ñ70ÂàÜÈêò)ÔºåÊñº„ÄåÂø†Ê≠¶Ë∑ØÁ´ô„Äç‰∏ãËªäÔºå‰∏ãËªäÂæåÂæÄÂõûËµ∞Á¥Ñ 2 ÂàÜÈêòÂç≥ÈÅî„ÄÇ' }, { time: '21:30', title: 'Check-in & ÊôöÈ§ê', type: 'food', desc: 'ÂÖ•‰ΩèÂæåÂêÉÁÇ∏ÈõûÊàñÈÉ®ÈöäÈçã„ÄÇ', location: 'Chungmuro' }] },
          { day: 2, date: '12/19 (‰∫î)', theme: 'Ê≠∑Âè≤Êº´Ê≠• & ÂÇ≥Áµ±ÈüªÂë≥', activities: [{ time: '10:00', title: 'ÊôØÁ¶èÂÆÆ', type: 'sight', desc: 'ÂèÉËßÄÂÖâÂåñÈñÄËàáÊôØÁ¶èÂÆÆÂÆàÈñÄÂ∞áÊèõÂ¥óÂÑÄÂºè (10:00)„ÄÇ', location: 'Gyeongbokgung', transport: 'üü†3ËôüÁ∑ö Âø†Ê≠¶Ë∑ØÁ´ô -> (ÂæÄÂ§ßÂåñÊñπÂêëÔºå3Á´ô) -> ÊôØÁ¶èÂÆÆÁ´ô (5ËôüÂá∫Âè£)ÔºåÂá∫Á´ôÂæåÁõ¥Ëµ∞Âç≥ÈÅîÂÖâÂåñÈñÄÂª£Â†¥„ÄÇ' }, { time: '12:30', title: 'Âúü‰øóÊùëËîòÈõûÊπØ', type: 'food', desc: '‰∫´Áî®ËëóÂêçÁöÑËîòÈõûÊπØÊöñË∫´„ÄÇ', location: 'Seochon', transport: 'ÂæíÊ≠•ÔºöÂæûÊôØÁ¶èÂÆÆÁ´ô 2 ËôüÂá∫Âè£Âá∫‰æÜÔºåÁõ¥Ëµ∞Á¥Ñ 120 ÂÖ¨Â∞∫ÔºåÂú® GS25 ‰æøÂà©ÂïÜÂ∫óÂ∑¶ËΩâÈÄ≤ÂÖ•Á¥´ÈúûÈñÄË∑Ø 5 Â∑∑ÔºåÁõ¥Ëµ∞Âç≥ÈÅî„ÄÇ' }, { time: '14:30', title: 'ÂåóÊùëÈüìÂ±ãÊùë & ‰∏âÊ∏ÖÊ¥û', type: 'walk', desc: 'Êº´Ê≠•ÊñºÂÇ≥Áµ±ÈüìÂ±ãÁæ§ÔºåÂ∞ãÊâæÂåóÊùëÂÖ´ÊôØÔºåÈö®ÂæåÂú®‰∏âÊ∏ÖÊ¥ûÂíñÂï°Âª≥‰ºëÊÅØ„ÄÇ', location: 'Bukchon', transport: 'ÂæíÊ≠•ÔºöÊ≤øËëóÊôØÁ¶èÂÆÆÁü≥ÁâÜË∑ØÂæÄÊù±Ëµ∞ÔºåÁ∂ìÈÅéÂúãÁ´ãÊ∞ë‰øóÂçöÁâ©È§®ÔºåÁ©øË∂ä‰∏âÊ∏ÖÊ¥ûË∑ØÔºåÊ≠•Ë°åÁ¥Ñ 15-20 ÂàÜÈêò„ÄÇ' }, { time: '18:00', title: '‰ªÅÂØ∫Ê¥ûÊ≠•Ë°åË°ó', type: 'shopping', desc: 'ÂèÉËßÄ‰∫∫‰∫∫Âª£Â†¥ (Ssamzigil)ÔºåË≥ºË≤∑ÂÇ≥Áµ±Â∑•ËóùÂìÅ„ÄÇ', location: 'Insadong', transport: 'ÂæíÊ≠•ÔºöÂæûÂåóÊùëÊ≤øËëóÂÆâÂúãÁ´ôÊñπÂêëÂæÄÂçóËµ∞ÔºåÈÅéÈ¶¨Ë∑ØÂç≥ÈÄ≤ÂÖ•‰ªÅÂØ∫Ê¥û‰∏ªË°ó (Á¥Ñ 10 ÂàÜÈêò)„ÄÇ' }, { time: '20:00', title: 'Ê∏ÖÊ∫™Â∑ùÂ§úÈñìÊï£Ê≠•', type: 'walk', desc: 'Ê¨£Ë≥ûÊ∏ÖÊ∫™Â∑ùËÅñË™ïÁáàÈ£æ (Â¶ÇÊúâÊ¥ªÂãï) ÊàñÂ§úÊôØ„ÄÇ', location: 'Cheonggyecheon', transport: 'ÂæíÊ≠•ÔºöÂæû‰ªÅÂØ∫Ê¥û‰∏ªË°óÂæÄÂçóÁõ¥Ëµ∞ÔºåÁ∂ìÈÅéÈêòÈñ£Á´ôÔºåÊ≠•Ë°åÁ¥Ñ 8 ÂàÜÈêòÂç≥ÂèØÊäµÈÅîÊ∏ÖÊ∫™Â∑ùÂª£Â†¥„ÄÇ' }] },
          { day: 3, date: '12/20 (ÂÖ≠)', theme: 'È¶ñÁàæÂÖ®ÊôØ & Ë≥ºÁâ©', activities: [{ time: '10:30', title: 'ÂçóÂ±±ÂÖ¨Âúí & NÈ¶ñÁàæÂ°î', type: 'sight', desc: 'Êê≠‰πòÂçóÂ±±Á∫úËªä‰∏äÂ±±Ôºå‰øØÁû∞È¶ñÁàæÂÖ®ÊôØÔºåÈéñ‰∏äÊÑõÊÉÖÈéñ„ÄÇ', location: 'Namsan', transport: 'ÂæíÊ≠•+Á∫úËªäÔºöüîµ4ËôüÁ∑ö ÊòéÊ¥ûÁ´ô 3ËôüÂá∫Âè£ÔºåÊ≤øËëóÂ§™Âπ≥Ê¥ãÈ£ØÂ∫óÂè≥ÂÅ¥Âù°ÈÅìÊ≠•Ë°åÁ¥Ñ 10 ÂàÜÈêòËá≥Á∫úËªäÊê≠‰πòËôïÔºåÊê≠‰πòÁ∫úËªä‰∏äÂ±±„ÄÇ' }, { time: '13:30', title: 'ÂçóÂ±±ÁÇ∏Ë±¨Êéí', type: 'food', desc: 'ÂòóË©¶ÂçóÂ±±ËÖ≥‰∏ãËëóÂêçÁöÑÂ∑®ÁÑ°Èú∏ÁÇ∏Ë±¨Êéí„ÄÇ', location: 'Namsan', transport: 'ÂæíÊ≠•ÔºöÂæûÁ∫úËªäÁ´ô‰∏ãÂ±±ÂæåÔºåÊ≤øËëóÂ∞èÂù°Ë∑ØÂæÄ‰∏ãËµ∞Á¥Ñ 5 ÂàÜÈêòÔºåÂç≥ÂèØÁúãÂà∞ÁÇ∏Ë±¨Êéí‰∏ÄÊ¢ùË°ó„ÄÇ' }, { time: '15:00', title: 'ÊòéÊ¥ûÂïÜÂúàË≥ºÁâ©', type: 'shopping', desc: 'ÁæéÂ¶ù„ÄÅÊúçÈ£æÊé°Ë≥ºÔºåÈ´îÈ©óÊòéÊ¥ûÂ∞èÂêÉ (ÈõûËõãÁ≥ï„ÄÅÁ≥ñÈ§Ö)„ÄÇ', location: 'Myeongdong', transport: 'ÂæíÊ≠•ÔºöÂæûÂçóÂ±±Ëµ∞ÂõûÊòéÊ¥ûÁ´ôÔºåÁ©øË∂äÂú∞‰∏ãÈÅìÊàñÊñëÈ¶¨Á∑öÈÄ≤ÂÖ•ÊòéÊ¥ûÂïÜÂúà‰∏ªË°ó„ÄÇ' }, { time: '19:00', title: '‰∫ÇÊâìÁßÄ (Nanta) Êàñ ‰ºëÊÅØ', type: 'show', desc: 'ÂèØÈÅ∏ÊìáËßÄË≥ûÈüìÂúãËëóÂêçÁöÑÁÑ°Ë™ûË®ÄÈü≥Ê®ÇÂäáÔºåÊàñÂõûÂø†Ê≠¶Ë∑ØÈôÑËøë‰ºëÊÅØ„ÄÇ', location: 'Myeongdong' }] },
          { day: 4, date: '12/21 (Êó•)', theme: 'Âú≠Ë≥¢ÊºîÂî±ÊúÉ & ÈüìÂ±ãÈ¢®ÊÉÖ', activities: [{ time: '10:00', title: 'ÂçóÂ±±Ë∞∑ÈüìÂ±ãÊùë', type: 'sight', desc: '‰ΩçÊñºÂø†Ê≠¶Ë∑ØÁ´ôÊóÅÔºåËºïÈ¨ÜÊï£Ê≠•È´îÈ©óÂÇ≥Áµ±Â∫≠ÂúíÔºå‰∏çÈúÄÈñÄÁ•®„ÄÇ', location: 'Chungmuro', transport: 'ÂæíÊ≠•ÔºöÂæû Wecostay Ê≠•Ë°åÁ¥Ñ 5 ÂàÜÈêòÔºåÁî±Âø†Ê≠¶Ë∑ØÁ´ô 3 Êàñ 4 ËôüÂá∫Âè£ÊóÅÂÖ•Âè£ÈÄ≤ÂÖ•„ÄÇ' }, { time: '12:00', title: 'ÂçàÈ§ê & ‰ºëÊÅØ', type: 'food', desc: 'Âú®Âø†Ê≠¶Ë∑ØÈôÑËøëÁî®È§êÔºå‰∏¶ÂõûÈ£ØÂ∫óÁ®ç‰ΩúÊï¥ÁêÜÔºåÊ∫ñÂÇôÂâçÂæÄÊºîÂî±ÊúÉ„ÄÇ', location: 'Wecostay' }, { time: '14:30', title: 'ÂâçÂæÄ Olympic Hall', type: 'train', desc: 'ÂâçÂæÄÂ•ßÊûóÂåπÂÖãÂÖ¨Âúí„ÄÇ', location: 'Olympic Park', transport: 'Âú∞ÈêµËΩâ‰πòÔºöüîµ4ËôüÁ∑ö Âø†Ê≠¶Ë∑ØÁ´ô -> (ÂæÄÁï∂Â∂∫ÊñπÂêëÔºå1Á´ô) -> Êù±Â§ßÈñÄÊ≠∑Âè≤ÊñáÂåñÂÖ¨ÂúíÁ´ôÔºåËΩâ‰πòüü£5ËôüÁ∑ö (ÂæÄÈ¶¨Â∑ù/Ê≤≥ÂçóÈªî‰∏πÂ±±ÊñπÂêëÔºåÁ¥Ñ13Á´ô) -> Â•ßÊûóÂåπÂÖãÂÖ¨ÂúíÁ´ô (3ËôüÂá∫Âè£)„ÄÇ' }, { time: '17:00', title: '2025 KYUHYUN Concert', type: 'music', desc: '‚ÄúThe Classic‚Äù ÊºîÂî±ÊúÉ @ Olympic Hall„ÄÇ‰∫´ÂèóÂú≠Ë≥¢ÁöÑÊ≠åËÅ≤ÔºÅ', location: 'Olympic Park' }, { time: '20:30', title: 'ËøîÂõûÂ∏ÇÂçÄ & ÊôöÈ§ê', type: 'food', desc: 'ÊºîÂî±ÊúÉÁµêÊùüÂæåÊê≠Âú∞ÈêµËøîÂõûÔºåÂêÉÈ†ìÁÜ±È®∞È®∞ÁöÑÁÉ§ËÇâÊÖ∂Âäü„ÄÇ', location: 'Chungmuro', transport: 'Âú∞ÈêµËΩâ‰πòÔºöÂéüË∑ØËøîÂõûËá≥Âø†Ê≠¶Ë∑ØÁ´ôÔºåÁî± 1 ËôüÂá∫Âè£Ê≠•Ë°åËá≥ÁÉ§ËÇâÂ∫ó„ÄÇ' }] },
          { day: 5, date: '12/22 (‰∏Ä)', theme: 'Áèæ‰ª£È¶ñÁàæ & Êº¢Ê±üÂ§úÊôØ', activities: [{ time: '11:00', title: 'The Hyundai Seoul', type: 'shopping', desc: 'ÂèÉËßÄÈ¶ñÁàæÊúÄÂ§ßÁöÑÁôæË≤®ÂÖ¨Âè∏„ÄÇ', location: 'Yeouido', transport: 'Âú∞ÈêµËΩâ‰πòÔºöüîµ4ËôüÁ∑ö Âø†Ê≠¶Ë∑ØÁ´ô -> (ÂæÄÁï∂Â∂∫ÊñπÂêëÔºå1Á´ô) -> Êù±Â§ßÈñÄÊ≠∑Âè≤ÊñáÂåñÂÖ¨ÂúíÁ´ôÔºåËΩâ‰πòüü£5ËôüÁ∑ö (ÂæÄÂÇçËä±ÊñπÂêëÔºå9Á´ô) -> Ê±ùÁü£Â∞ºÈ≠ØÁ´ô (1ËôüÂá∫Âè£)ÔºåÁõ¥ÈÄöÁôæË≤®„ÄÇ' }, { time: '15:00', title: 'Ê±ùÁü£Â≥∂Êº¢Ê±üÂÖ¨Âúí', type: 'walk', desc: 'Êº¢Ê±üÈÇäÊï£Ê≠•ÔºåÁßüÂÄüÈáéÈ§êÂ¢ä (Ëã•Â§©Ê∞£ÂÖÅË®±) ÊàñÂú®Êº¢Ê±üÊ≥°È∫µÊ©üÁÖÆÊãâÈ∫µ„ÄÇ', location: 'Yeouido', transport: 'ÂæíÊ≠•ÔºöÂæû The Hyundai 1 ËôüÈñÄÂá∫‰æÜÔºåÈÅéÈ¶¨Ë∑ØÂç≥ÈÅîÊ±ùÁü£Â≥∂Êº¢Ê±üÂÖ¨Âúí„ÄÇ' }, { time: '17:00', title: 'Êº¢Ê±üÈÅäË¶ΩËàπ', type: 'ship', desc: 'Eland Cruise Ê¨£Ë≥ûÊº¢Ê±üÂ§úÊôØ„ÄÇ', location: 'Yeouido Dock', transport: 'ÂæíÊ≠•ÔºöÊ≤øËëóÊº¢Ê±üÂÖ¨ÂúíÊ±üÈÇäÂæÄÊù±Ëµ∞ (ÁúãÂà∞ E-land Ê®ôË™å)ÔºåÊ≠•Ë°åÁ¥Ñ 10-15 ÂàÜÈêòËá≥ 2 ËôüÁ¢ºÈ†≠„ÄÇ' }, { time: '19:30', title: 'ÂºòÂ§ßÊôöÈ§ê', type: 'food', desc: 'ÂâçÂæÄÂÖÖÊªøÂπ¥ËºïÊ¥ªÂäõÁöÑÂºòÂ§ßÂïÜÂúà‰∫´Áî®ÊôöÈ§ê„ÄÇ', location: 'Hongdae', transport: 'Âú∞ÈêµËΩâ‰πòÔºöüü£5ËôüÁ∑ö Ê±ùÁü£Â∞ºÈ≠ØÁ´ô -> (ÂæÄÂÇçËä±ÊñπÂêëÔºå2Á´ô) -> Ê∞∏ÁôªÊµ¶ÂçÄÂª≥Á´ôÔºåËΩâ‰πòüü¢2ËôüÁ∑ö (ÂæÄÂêà‰∫ï/ÂºòÂ§ßÊñπÂêëÔºå2Á´ô) -> ÂºòÂ§ßÂÖ•Âè£Á´ô (9ËôüÂá∫Âè£)„ÄÇ' }] },
          { day: 6, date: '12/23 (‰∫å)', theme: '‰º¥ÊâãÁ¶ÆÊé°Ë≤∑ & ÊÇ†ÈñíÊôÇÂÖâ', activities: [{ time: '10:30', title: 'Âª£ËóèÂ∏ÇÂ†¥', type: 'food', desc: 'ÂìÅÂöêÁ∂†Ë±ÜÁÖéÈ§Ö„ÄÅÁîüÁâõËÇâ„ÄÅÈ∫ªËó•È£ØÊç≤„ÄÇ', location: 'Gwangjang Market', transport: 'Âú∞ÈêµËΩâ‰πòÔºöüîµ4ËôüÁ∑ö Âø†Ê≠¶Ë∑ØÁ´ô -> (ÂæÄÁï∂Â∂∫ÊñπÂêëÔºå2Á´ô) -> Êù±Â§ßÈñÄÁ´ôÔºåËΩâ‰πòüü¶1ËôüÁ∑ö (ÂæÄÈ¶ñÁàæÁ´ôÊñπÂêëÔºå1Á´ô) -> ÈêòË∑Ø5Ë°óÁ´ô (8ËôüÂá∫Âè£Âç≥ÊòØÂ∏ÇÂ†¥ÂÖ•Âè£)„ÄÇ' }, { time: '14:00', title: 'Ê®ÇÂ§©Ë∂ÖÂ∏Ç', type: 'shopping', desc: 'È¶ñÁàæÁ´ôÂ∫ó„ÄÇÊé°Ë≥ºÈõ∂È£ü„ÄÅÊ≥°È∫µ„ÄÅÊµ∑ËãîÁ≠â‰º¥ÊâãÁ¶Æ„ÄÇ', location: 'Seoul Station', transport: 'Âú∞ÈêµÁõ¥ÈÅîÔºöÁî±ÈêòË∑Ø5Ë°óÁ´ôÊê≠‰πòüü¶1ËôüÁ∑ö (ÂæÄÈ¶ñÁàæÁ´ô/‰ªÅÂ∑ùÊñπÂêëÔºå3Á´ô) -> È¶ñÁàæÁ´ô (1ËôüÂá∫Âè£Âá∫‰æÜ‰∏äÊâãÊâ∂Ê¢ØÂç≥ÈÅî)„ÄÇ' }, { time: '17:00', title: 'È£ØÂ∫óÊâìÂåÖ & ‰ºëÊÅØ', type: 'hotel', desc: 'Â∞áÊà∞Âà©ÂìÅÊîæÂõûÈ£ØÂ∫óÔºåÊï¥ÁêÜË°åÊùé„ÄÇ', location: 'Wecostay', transport: 'Âú∞ÈêµÁõ¥ÈÅîÔºöÁî±È¶ñÁàæÁ´ôÊê≠‰πòüîµ4ËôüÁ∑ö (ÂæÄÁï∂Â∂∫ÊñπÂêëÔºå2Á´ô) -> Âø†Ê≠¶Ë∑ØÁ´ô„ÄÇ' }, { time: '19:00', title: 'ÊúÄÂæåÁöÑÊôöÈ§ê', type: 'food', desc: 'Âú®‰πôÊîØË∑Ø (Hipjiro) È´îÈ©óÁç®ÁâπÁöÑÂ∑∑ÂºÑÈÖíÂêßÊàñÁÉ§ËÖ∏Â∫ó„ÄÇ', location: 'Euljiro', transport: 'ÂæíÊ≠•ÔºöÂæûÂø†Ê≠¶Ë∑ØÁ´ô 8 ËôüÂá∫Âè£ÔºåÊ≠•Ë°åÁ¥Ñ 5-8 ÂàÜÈêòËá≥‰πôÊîØË∑Ø 3 Ë°ó‰∏ÄÂ∏∂Â∑∑ÂºÑ„ÄÇ' }] },
          { day: 7, date: '12/24 (‰∏â)', theme: 'ÂëäÂà•È¶ñÁàæ & ËøîÂÆ∂', activities: [{ time: '06:00', title: 'ÈÄÄÊàø & ÂâçÂæÄÊ©üÂ†¥', type: 'bus', desc: 'Êê≠‰πò 6015 Ê©üÂ†¥Â∑¥Â£´ÂâçÂæÄ‰ªÅÂ∑ùÊ©üÂ†¥ (ÊàñÊê≠Ë®àÁ®ãËªäËá≥È¶ñÁàæÁ´ôÊê≠ AREX Áõ¥ÈÅîËªä)„ÄÇ', location: 'Airport Bus Stop', transport: 'Ê©üÂ†¥Â∑¥Â£´ÔºöÂâçÂæÄÂø†Ê≠¶Ë∑ØÁ´ô 1 ËôüÂá∫Âè£ÂâçÊñπÂÖ¨ËªäÁ´ôÔºåÊê≠‰πò„Äê6015 Ê©üÂ†¥Â∑¥Â£´„Äë(ÂæÄ‰ªÅÂ∑ùÊ©üÂ†¥ÊñπÂêë)ÔºåËªäÁ®ãÁ¥Ñ 70-80 ÂàÜÈêò„ÄÇ' }, { time: '07:35', title: 'Ëæ¶ÁêÜÁôªÊ©ü & ÈÄÄÁ®Ö', type: 'plane', desc: 'Èï∑Ê¶ÆËà™Á©∫Ê´ÉÊ™ØÂ†±Âà∞ÔºåËæ¶ÁêÜÂ∏ÇÂçÄÈÄÄÁ®ÖÂñÆÊìöÁöÑÊµ∑ÈóúËìãÁ´† (Ëã•ÈúÄË¶Å)„ÄÇ', location: 'ICN Airport' }, { time: '11:40', title: 'BR169 Ëµ∑È£õ', type: 'flight', desc: '‰ªÅÂ∑ù (ICN) -> Ê°ÉÂúí (TPE)', location: 'Departure Hall' }, { time: '13:30', title: 'ÊäµÈÅîÂè∞ÁÅ£', type: 'home', desc: 'Âπ≥ÂÆâÊäµÈÅîÊ∫´ÊöñÁöÑÂÆ∂„ÄÇ', location: 'Taipei' }] }
      ];

      const days_KR = JSON.parse(JSON.stringify(days_ZH)); 
      const days_EN = JSON.parse(JSON.stringify(days_ZH)); 
      const days_JP = JSON.parse(JSON.stringify(days_ZH)); 

      const data = {
        ZH: [day0_ZH, ...days_ZH],
        KR: [day0_KR, ...days_KR],
        EN: [day0_EN, ...days_EN],
        JP: [day0_JP, ...days_JP]
      };
      return data[lang];
    };

    // --- Components ---
    const IconType = ({ type, className }) => {
      const icons = { 
        checklist: ClipboardCheck, warning: AlertTriangle, warning_red: AlertTriangle, doc: FileText, ses: Scan, 
        flight: Plane, arrival: Plane, bus: Bus, car: Car, train: Train, food: Utensils, music: Music, sight: Camera, shopping: ShoppingBag, hotel: BedDouble, ship: Ship, walk: Footprints, show: Ticket, home: Home, default: MapPin 
      };
      const Icon = icons[type] || icons.default;
      return <Icon className={`${className} ${type === 'arrival' ? 'rotate-90' : ''} ${type === 'warning_red' ? 'text-red-500' : ''} ${type === 'warning' ? 'text-amber-500' : ''} ${type === 'ses' ? 'text-blue-500' : ''}`} />;
    };

    // Transport Formatter Component
    const TransportDisplay = ({ text }) => {
      if (!text) return null;
      
      // Regex to find line patterns: e.g., "1ËôüÁ∑ö", "Line 2", "AREX"
      const parts = text.split(/([1-9]ËôüÁ∑ö|Line\s*[1-9]|AREX|[1-9]Ìò∏ÏÑ†)/g);
      
      return (
        <span className="inline-flex flex-wrap items-center gap-1 align-middle ml-1">
          {parts.map((part, idx) => {
            let color = null;
            if (part.match(/1ËôüÁ∑ö|Line\s*1|1Ìò∏ÏÑ†/)) color = SUBWAY_COLORS['1'];
            else if (part.match(/2ËôüÁ∑ö|Line\s*2|2Ìò∏ÏÑ†/)) color = SUBWAY_COLORS['2'];
            else if (part.match(/3ËôüÁ∑ö|Line\s*3|3Ìò∏ÏÑ†/)) color = SUBWAY_COLORS['3'];
            else if (part.match(/4ËôüÁ∑ö|Line\s*4|4Ìò∏ÏÑ†/)) color = SUBWAY_COLORS['4'];
            else if (part.match(/5ËôüÁ∑ö|Line\s*5|5Ìò∏ÏÑ†/)) color = SUBWAY_COLORS['5'];
            else if (part.match(/6ËôüÁ∑ö|Line\s*6|6Ìò∏ÏÑ†/)) color = SUBWAY_COLORS['6'];
            else if (part.match(/7ËôüÁ∑ö|Line\s*7|7Ìò∏ÏÑ†/)) color = SUBWAY_COLORS['7'];
            else if (part.match(/8ËôüÁ∑ö|Line\s*8|8Ìò∏ÏÑ†/)) color = SUBWAY_COLORS['8'];
            else if (part.match(/9ËôüÁ∑ö|Line\s*9|9Ìò∏ÏÑ†/)) color = SUBWAY_COLORS['9'];
            else if (part.match(/AREX/i)) color = SUBWAY_COLORS['AREX'];

            if (color) {
              return <span key={idx} className="px-1.5 py-0.5 rounded text-white font-bold text-[10px] inline-block" style={{ backgroundColor: color }}>{part}</span>;
            }
            return <span key={idx} className="text-xs text-stone-500">{part}</span>;
          })}
        </span>
      );
    };

    const ActivityWeather = ({ day, index, location }) => {
      const isTaiwan = location && ['Home', 'TPE', 'Taipei', 'Taiwan', 'Taoyuan', 'ÂÆ∂', 'Ê°ÉÂúí', 'Âè∞Âåó', 'Âè∞ÁÅ£'].some(k => location.includes(k));
      const seed = day * 10 + index;
      let weatherTypes, temp;
      if (isTaiwan) {
        weatherTypes = ['sunny', 'cloudy', 'rain']; 
        temp = Math.floor((seed * 9301 + 49297) % 8) + 15;
      } else {
        weatherTypes = ['sunny', 'cloudy', 'snow'];
        temp = Math.floor((seed * 9301 + 49297) % 15) - 10; 
      }
      const type = weatherTypes[seed % weatherTypes.length];
      const getIcon = () => {
        if (type === 'sunny') return <Sun className="w-3 h-3 text-amber-400" />;
        if (type === 'snow') return <Snowflake className="w-3 h-3 text-sky-300" />;
        if (type === 'rain') return <CloudRain className="w-3 h-3 text-slate-400" />;
        return <Cloud className="w-3 h-3 text-slate-400" />;
      };
      return (
        <div className="flex items-center gap-1 text-[10px] font-medium text-stone-500 bg-stone-50 px-1.5 py-0.5 rounded-full shrink-0 ml-2">
          {getIcon()}
          <span>{temp}¬∞</span>
        </div>
      );
    };

    const TimeWeatherWidget = () => {
      const [time, setTime] = useState(new Date());
      const [temp, setTemp] = useState(-2);
      const [condition, setCondition] = useState('cloudy');
      useEffect(() => { const t = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(t); }, []);
      const seoulTime = new Date(time.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
      const getIcon = () => {
        if (condition === 'sunny') return <Sun className="w-4 h-4 text-amber-400" />;
        if (condition === 'snow') return <Snowflake className="w-4 h-4 text-sky-300" />;
        return <Cloud className="w-4 h-4 text-slate-400" />;
      };
      return (
        <div className="flex flex-col items-end gap-1">
           <div className="flex items-center gap-2 bg-white/80 backdrop-blur-md px-3 py-1 md:px-4 md:py-2 rounded-2xl shadow-sm border border-rose-100">
             <div className="flex flex-col items-end border-r border-rose-100 pr-2 md:pr-4">
               <span className="text-[8px] md:text-[10px] text-rose-800 font-bold tracking-wider">SEOUL</span>
               <span className="text-lg md:text-xl font-mono font-bold text-rose-900 leading-none">{seoulTime.getHours().toString().padStart(2,'0')}:{seoulTime.getMinutes().toString().padStart(2,'0')}</span>
             </div>
             <div className="flex items-center gap-2">{getIcon()}<span className="text-lg font-bold text-stone-700">{temp}¬∞C</span></div>
           </div>
        </div>
      );
    };

    const RealTimeDateDisplay = () => {
      const [dateStr, setDateStr] = useState('');
      useEffect(() => {
        const updateDate = () => {
          const now = new Date();
          const seoulTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
          const y = seoulTime.getFullYear();
          const m = String(seoulTime.getMonth() + 1).padStart(2, '0');
          const d = String(seoulTime.getDate()).padStart(2, '0');
          const days = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠'];
          const dayName = days[seoulTime.getDay()];
          setDateStr(`${y}/${m}/${d} (${dayName})`);
        };
        updateDate();
        const timer = setInterval(updateDate, 60000);
        return () => clearInterval(timer);
      }, []);
      return <span className="text-sm font-bold text-rose-900/90 mt-0.5 block">{dateStr}</span>;
    };

    const EditableText = ({ text, className, multiline = false, onSave }) => {
      const [isEditing, setIsEditing] = useState(false);
      const [value, setValue] = useState(text);
      useEffect(() => setValue(text), [text]);
      const handleBlur = () => { setIsEditing(false); onSave(value); };
      if (isEditing) return multiline ? <textarea autoFocus className={`w-full bg-white border border-rose-300 rounded p-2 focus:ring-2 focus:ring-rose-400 outline-none text-stone-700 ${className}`} value={value} onChange={(e) => setValue(e.target.value)} onBlur={handleBlur} rows={3} /> : <input autoFocus type="text" className={`w-full bg-white border border-rose-300 rounded px-1 focus:ring-2 focus:ring-rose-400 outline-none text-stone-700 ${className}`} value={value} onChange={(e) => setValue(e.target.value)} onBlur={handleBlur} />;
      return <div onClick={() => setIsEditing(true)} className={`cursor-pointer hover:bg-rose-50/50 rounded px-1 transition-colors border border-transparent hover:border-rose-100 group relative ${className}`}>{value}<Edit3 className="w-3 h-3 text-rose-300 absolute -right-4 top-1 opacity-0 group-hover:opacity-100 transition-opacity" /></div>;
    };

    const MagicPhraseModal = ({ activity, lang, onClose }) => {
      const [phrases, setPhrases] = useState([]);
      const [loading, setLoading] = useState(true);
      const [errorMsg, setErrorMsg] = useState(null);
      const speak = (text) => {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'ko-KR';
        utterance.rate = 0.9;
        window.speechSynthesis.speak(utterance);
      };
      useEffect(() => {
        const generatePhrases = async () => {
          const targetLang = lang === 'ZH' || lang === 'KR' ? 'Traditional Chinese' : (lang === 'JP' ? 'Japanese' : 'English');
          const prompt = `Context: Tourist in Seoul doing "${activity.title}" (${activity.type}). Generate 4 short, useful Korean phrases. Output JSON only: [{"korean": "...", "pronunciation": "...", "meaning": "..."}]. Meaning in ${targetLang}.`;
          const custom = activity.customPhrases || [];
          const result = await callGeminiAPI(prompt, "You are a Korean tutor. Output pure JSON.");
          if (result.success) {
            try {
               const cleanJson = result.data.replace(/```json/g, '').replace(/```/g, '').trim();
               const aiPhrases = JSON.parse(cleanJson);
               setPhrases([...custom, ...aiPhrases]);
            } catch (e) { setPhrases([...custom, ...(FALLBACK_PHRASES_BY_TYPE[activity.type] || FALLBACK_PHRASES_BY_TYPE.default)]); setErrorMsg(UI_LABELS[lang].fallbackMsg); }
          } else {
            setPhrases([...custom, ...(FALLBACK_PHRASES_BY_TYPE[activity.type] || FALLBACK_PHRASES_BY_TYPE.default)]);
            setErrorMsg(UI_LABELS[lang].fallbackMsg);
          }
          setLoading(false);
        };
        generatePhrases();
      }, [activity, lang]);
      return (
        <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[60] flex items-center justify-center p-4" onClick={onClose}>
          <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden animate-fade-in" onClick={(e) => e.stopPropagation()}>
            <div className="bg-gradient-to-r from-rose-300 to-rose-400 p-4 flex justify-between items-center text-white">
              <div className="flex items-center gap-2"><Languages size={20} /><div><h3 className="font-bold text-sm">{UI_LABELS[lang].phrasesTitle}</h3><p className="text-[10px] opacity-90 truncate max-w-[200px]">{activity.title}</p></div></div>
              <button onClick={onClose}><X size={20} /></button>
            </div>
            <div className="p-4 min-h-[200px]">
              {loading ? <div className="flex flex-col items-center justify-center h-32"><Loader2 className="animate-spin text-rose-400" /></div> : (
                <div className="space-y-2">
                  {errorMsg && <div className="flex items-center gap-2 bg-amber-50 text-amber-600 text-xs p-2 rounded">{errorMsg}</div>}
                  {phrases.map((p, i) => (
                    <div key={i} className="bg-rose-50 rounded-xl p-3 border border-rose-100 flex justify-between items-center gap-2">
                      <div className="flex-1"><span className="font-bold text-rose-900 block">{p.korean}</span><div className="text-xs text-rose-600/80">{p.pronunciation}</div><div className="text-sm text-stone-600">{p.meaning}</div></div>
                      <button onClick={() => speak(p.korean)} className="p-2 bg-white text-rose-400 rounded-full shadow-sm"><Volume2 size={18} /></button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    const AIChatWidget = ({ itinerary, lang }) => {
      const [isOpen, setIsOpen] = useState(false);
      const [messages, setMessages] = useState([]);
      const [input, setInput] = useState("");
      const [loading, setLoading] = useState(false);
      const scrollRef = useRef(null);
      useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages, isOpen]);
      const handleSend = async () => {
        if (!input.trim()) return;
        const userMsg = { role: 'user', text: input };
        setMessages(prev => [...prev, userMsg]);
        setInput("");
        setLoading(true);
        const result = await callGeminiAPI(input, `You are a Seoul guide. Context: ${JSON.stringify(itinerary)}. Lang: ${lang}. Keep it short.`);
        setMessages(prev => [...prev, { role: 'model', text: result.success ? result.data : "Network error." }]);
        setLoading(false);
      };
      return (
        <>
          {!isOpen && <button onClick={() => setIsOpen(true)} className="fixed bottom-6 right-6 bg-gradient-to-br from-rose-400 to-rose-500 text-white p-4 rounded-full shadow-lg hover:scale-105 transition-all z-40"><Bot size={28} /></button>}
          {isOpen && (
            <div className="fixed bottom-6 right-6 w-[90vw] md:w-[380px] h-[500px] bg-white rounded-3xl shadow-2xl z-50 flex flex-col overflow-hidden border border-rose-100 animate-fade-in">
              <div className="bg-gradient-to-r from-rose-400 to-rose-500 p-4 flex justify-between text-white"><div className="flex gap-2 items-center"><Sparkles size={18} /><h3>{UI_LABELS[lang].aiChat}</h3></div><button onClick={() => setIsOpen(false)}><X size={20} /></button></div>
              <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-stone-50" ref={scrollRef}>
                {messages.map((m, i) => (<div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[85%] rounded-2xl p-3 text-sm ${m.role === 'user' ? 'bg-rose-400 text-white' : 'bg-white shadow-sm'}`}>{m.text}</div></div>))}
                {loading && <Loader2 className="animate-spin text-rose-400" />}
              </div>
              <div className="p-3 border-t"><div className="flex gap-2 bg-stone-100 rounded-full px-4 py-2"><input className="flex-1 bg-transparent outline-none text-sm" value={input} onChange={e => setInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSend()} placeholder={UI_LABELS[lang].chatPlaceholder} /><button onClick={handleSend}><Send size={18} className="text-rose-400" /></button></div></div>
            </div>
          )}
        </>
      );
    };

    const AddEventModal = ({ onClose, onSave, lang }) => {
      const [time, setTime] = useState('');
      const [title, setTitle] = useState('');
      const handleSave = () => { if (!title) return; onSave(time || '00:00', title); };
      return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[80] flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-in">
            <div className="bg-rose-400 p-4 text-white font-bold text-center">{UI_LABELS[lang].addModalTitle}</div>
            <div className="p-5 space-y-4">
              <div><label className="block text-xs text-stone-500 mb-1">{UI_LABELS[lang].addModalTime}</label><input type="time" className="w-full border border-stone-200 rounded-lg p-2 text-stone-700 outline-none focus:ring-2 focus:ring-rose-300" value={time} onChange={(e) => setTime(e.target.value)} /></div>
              <div><label className="block text-xs text-stone-500 mb-1">{UI_LABELS[lang].addModalContent}</label><input type="text" className="w-full border border-stone-200 rounded-lg p-2 text-stone-700 outline-none focus:ring-2 focus:ring-rose-300" value={title} onChange={(e) => setTitle(e.target.value)} /></div>
              <div className="flex gap-3 pt-2"><button onClick={onClose} className="flex-1 py-2 rounded-lg bg-stone-100 text-stone-600 font-bold text-sm">{UI_LABELS[lang].addModalCancel}</button><button onClick={handleSave} className="flex-1 py-2 rounded-lg bg-rose-400 text-white font-bold text-sm shadow-md">{UI_LABELS[lang].addModalSubmit}</button></div>
            </div>
          </div>
        </div>
      );
    };

    const SplitBillModal = ({ onClose, lang }) => {
      const [partners, setPartners] = useState('');
      const [expenses, setExpenses] = useState([]);
      const [newExpense, setNewExpense] = useState({ payer: '', amount: '', description: '' });
      const [result, setResult] = useState(null);

      useEffect(() => {
        const saved = localStorage.getItem('seoul2025_split_bill');
        if (saved) {
          const data = JSON.parse(saved);
          setPartners(data.partners || '');
          setExpenses(data.expenses || []);
        }
      }, []);

      useEffect(() => {
        localStorage.setItem('seoul2025_split_bill', JSON.stringify({ partners, expenses }));
      }, [partners, expenses]);

      const handleAddExpense = () => {
        if (!newExpense.payer || !newExpense.amount) return;
        setExpenses([...expenses, { ...newExpense, id: Date.now() }]);
        setNewExpense({ ...newExpense, amount: '', description: '' });
      };

      const handleCalculate = () => {
        const people = partners.split(/[,Ôºå]/).map(p => p.trim()).filter(p => p);
        if (people.length < 2) return;
        const balances = {};
        people.forEach(p => balances[p] = 0);
        let totalSpent = 0;
        expenses.forEach(e => {
          if (balances[e.payer] !== undefined) {
            balances[e.payer] += parseFloat(e.amount);
            totalSpent += parseFloat(e.amount);
          }
        });
        const average = totalSpent / people.length;
        const debts = [];
        const details = people.map(p => ({ name: p, balance: balances[p] - average }));
        let debtors = details.filter(d => d.balance < -0.01).sort((a, b) => a.balance - b.balance);
        let creditors = details.filter(d => d.balance > 0.01).sort((a, b) => b.balance - a.balance);
        let i = 0, j = 0;
        while (i < debtors.length && j < creditors.length) {
          const debtor = debtors[i];
          const creditor = creditors[j];
          const amount = Math.min(Math.abs(debtor.balance), creditor.balance);
          debts.push({ from: debtor.name, to: creditor.name, amount: amount.toFixed(0) });
          debtor.balance += amount;
          creditor.balance -= amount;
          if (Math.abs(debtor.balance) < 0.01) i++;
          if (creditor.balance < 0.01) j++;
        }
        setResult(debts);
      };

      const peopleList = partners.split(/[,Ôºå]/).map(p => p.trim()).filter(p => p);

      return (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[80] flex items-center justify-center p-4" onClick={onClose}>
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in flex flex-col max-h-[80vh]" onClick={e => e.stopPropagation()}>
            <div className="bg-emerald-500 p-4 text-white font-bold text-center flex justify-between items-center">
              <div className="flex items-center gap-2"><Banknote size={20} /> {UI_LABELS[lang].splitBill}</div>
              <button onClick={onClose}><X size={20} /></button>
            </div>
            <div className="p-4 overflow-y-auto flex-1 space-y-4">
              <div>
                <label className="block text-xs text-stone-500 mb-1">ÊóÖË°å‰ºô‰º¥ (Áî®ÈÄóËôüÂàÜÈöî)</label>
                <input type="text" className="w-full border border-stone-200 rounded-lg p-2 text-sm" placeholder="Â∞èÊòé, Â∞èÁæé, ÈòøÂëÜ" value={partners} onChange={e => setPartners(e.target.value)} />
              </div>
              {peopleList.length > 0 && (
                <div className="bg-stone-50 p-3 rounded-xl space-y-2 border border-stone-100">
                  <div className="flex gap-2">
                    <select className="flex-1 border rounded-lg p-1.5 text-sm" value={newExpense.payer} onChange={e => setNewExpense({...newExpense, payer: e.target.value})}>
                      <option value="">Ë™∞‰ªòÈå¢?</option>
                      {peopleList.map(p => <option key={p} value={p}>{p}</option>)}
                    </select>
                    <input type="number" className="w-24 border rounded-lg p-1.5 text-sm" placeholder="ÈáëÈ°ç" value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} />
                  </div>
                  <div className="flex gap-2">
                    <input type="text" className="flex-1 border rounded-lg p-1.5 text-sm" placeholder="È†ÖÁõÆ (ÂèØÈÅ∏)" value={newExpense.description} onChange={e => setNewExpense({...newExpense, description: e.target.value})} />
                    <button onClick={handleAddExpense} className="bg-emerald-500 text-white px-3 rounded-lg text-sm font-bold">+</button>
                  </div>
                </div>
              )}
              <div className="space-y-1 max-h-40 overflow-y-auto">
                {expenses.map((ex, idx) => (
                  <div key={ex.id} className="flex justify-between text-sm p-2 bg-white border rounded-lg items-center">
                    <span><span className="font-bold text-emerald-600">{ex.payer}</span> ‰ªò‰∫Ü {ex.amount} {ex.description && `(${ex.description})`}</span>
                    <button onClick={() => setExpenses(expenses.filter(e => e.id !== ex.id))} className="text-stone-400 hover:text-red-400"><Trash2 size={14}/></button>
                  </div>
                ))}
              </div>
              {result && (
                <div className="bg-emerald-50 p-3 rounded-xl border border-emerald-100">
                  <h4 className="font-bold text-emerald-800 text-sm mb-2">ÁµêÁÆóÁµêÊûúÔºö</h4>
                  {result.length === 0 ? <p className="text-sm text-emerald-600">ÁõÆÂâçÊ≤íÊúâ‰∫∫ÈúÄË¶Å‰ªòÈå¢Áµ¶Ë™∞</p> : (
                    <ul className="space-y-1 text-sm text-emerald-700">
                      {result.map((r, i) => <li key={i}><span className="font-bold">{r.from}</span> Áµ¶ <span className="font-bold">{r.to}</span>: {r.amount}</li>)}
                    </ul>
                  )}
                </div>
              )}
            </div>
            <div className="p-4 border-t">
              <button onClick={handleCalculate} className="w-full bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-md hover:bg-emerald-600">Ë®àÁÆóÂàÜÂ∏≥</button>
            </div>
          </div>
        </div>
      );
    };

    // --- Settings Modal ---
    const SettingsModal = ({ onClose, lang }) => {
        const [apiKey, setApiKey] = useState('');
        
        useEffect(() => {
            const savedKey = localStorage.getItem('gemini_api_key') || '';
            setApiKey(savedKey);
        }, []);

        const handleSave = () => {
            localStorage.setItem('gemini_api_key', apiKey.trim());
            alert('API Key Â∑≤ÂÑ≤Â≠òÔºÅ');
            onClose();
        };

        return (
            <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[90] flex items-center justify-center p-4" onClick={onClose}>
                <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-fade-in" onClick={e => e.stopPropagation()}>
                    <div className="bg-stone-700 p-4 text-white font-bold text-center flex justify-between items-center">
                        <div className="flex items-center gap-2"><Settings size={20} /> {UI_LABELS[lang].settings}</div>
                        <button onClick={onClose}><X size={20} /></button>
                    </div>
                    <div className="p-5 space-y-4">
                        <div>
                            <label className="block text-xs text-stone-500 mb-1">Google Gemini API Key</label>
                            <input 
                                type="password" 
                                className="w-full border border-stone-200 rounded-lg p-2 text-stone-700 outline-none focus:ring-2 focus:ring-stone-400 font-mono text-sm" 
                                placeholder={UI_LABELS[lang].apiKeyPlaceholder}
                                value={apiKey} 
                                onChange={(e) => setApiKey(e.target.value)} 
                            />
                            <p className="text-[10px] text-stone-400 mt-1">Key Â∞áÂÑ≤Â≠òÊñºÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏≠Ôºå‰∏çÊúÉ‰∏äÂÇ≥Ëá≥ÂÖ∂‰ªñ‰º∫ÊúçÂô®„ÄÇ</p>
                        </div>
                        <button onClick={handleSave} className="w-full bg-stone-700 text-white py-2 rounded-lg font-bold shadow-md hover:bg-stone-800 transition-colors">
                            {UI_LABELS[lang].addModalSubmit}
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    const loadData = (language) => {
        const key = `seoul_trip_2025_${language}`;
        try { 
          const saved = localStorage.getItem(key); 
          if (saved) {
            const parsed = JSON.parse(saved);
            if (parsed && parsed[0] && parsed[0].activities) {
               parsed[0].activities.forEach(act => {
                  if (act.items && act.items.length > 0 && typeof act.items[0] === 'string') {
                     act.items = act.items.map(text => ({ text, checked: false }));
                  }
               });
            }
            return parsed; 
          }
        } catch (e) { console.error("Failed to load itinerary", e); }
        return getInitialItinerary(language);
    };

    function App() {
      const [lang, setLang] = useState('ZH');
      const [activeDay, setActiveDay] = useState(0);
      const [itinerary, setItinerary] = useState(() => loadData('ZH'));
      const [selectedActivity, setSelectedActivity] = useState(null);
      const [showAddEventModal, setShowAddEventModal] = useState(false);
      const [showSplitBill, setShowSplitBill] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      
      const touchStartX = useRef(null);
      const onTouchStart = e => touchStartX.current = e.targetTouches[0].clientX;
      const onTouchEnd = e => { if (!touchStartX.current) return; const diff = touchStartX.current - e.changedTouches[0].clientX; if (diff > 50 && activeDay < itinerary.length - 1) setActiveDay(p => p + 1); if (diff < -50 && activeDay > 0) setActiveDay(p => p - 1); };
      const getInitialActiveDay = () => { const now = new Date(); const year = now.getFullYear(); const month = now.getMonth(); const date = now.getDate(); if (year === 2025 && month === 11 && date >= 18 && date <= 24) return date - 18 + 1; return 0; };

      useEffect(() => { setActiveDay(getInitialActiveDay()); }, []);
      useEffect(() => { const key = `seoul_trip_2025_${lang}`; localStorage.setItem(key, JSON.stringify(itinerary)); }, [itinerary, lang]);

      const handleLangChange = (newLang) => {
          setLang(newLang);
          const savedData = loadData(newLang);
          setItinerary(savedData);
      };

      const forceSave = () => {
          const key = `seoul_trip_2025_${lang}`; 
          localStorage.setItem(key, JSON.stringify(itinerary));
          alert('Ë°åÁ®ãÂ∑≤ÂÑ≤Â≠òÔºÅ');
      };

      const updateActivity = (d, a, f, v) => { 
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[d] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[a] };
        newActivity[f] = v;
        newActivities[a] = newActivity;
        newDay.activities = newActivities;
        newItinerary[d] = newDay;
        setItinerary(newItinerary); 
      };
      
      const updateTheme = (d, v) => { 
        const newItinerary = [...itinerary]; 
        newItinerary[d] = { ...newItinerary[d], theme: v };
        setItinerary(newItinerary); 
      };
      
      const handleSaveNewEvent = (time, title) => {
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[activeDay] };
        const newActivities = [...newDay.activities];
        newActivities.push({ time: time, title: title, type: 'default', desc: 'ÈªûÊìäÁ∑®ËºØÂÖßÂÆπ', location: title, transport: '' });
        newActivities.sort((a, b) => { const tA = a.time || "99:99"; const tB = b.time || "99:99"; return tA.localeCompare(tB); });
        newDay.activities = newActivities;
        newItinerary[activeDay] = newDay;
        setItinerary(newItinerary);
        setShowAddEventModal(false);
      };
      
      const toggleCheck = (dayIdx, actIdx, itemIdx) => {
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[dayIdx] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[actIdx] };
        const newItems = [...newActivity.items];
        newItems[itemIdx] = { ...newItems[itemIdx], checked: !newItems[itemIdx].checked };
        newActivity.items = newItems;
        newActivities[actIdx] = newActivity;
        newDay.activities = newActivities;
        newItinerary[dayIdx] = newDay;
        setItinerary(newItinerary);
      };

      const updateChecklistItemText = (dayIdx, actIdx, itemIdx, text) => {
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[dayIdx] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[actIdx] };
        const newItems = [...newActivity.items];
        newItems[itemIdx] = { ...newItems[itemIdx], text: text };
        newActivity.items = newItems;
        newActivities[actIdx] = newActivity;
        newDay.activities = newActivities;
        newItinerary[dayIdx] = newDay;
        setItinerary(newItinerary);
      };

      const addChecklistItem = (dayIdx, actIdx) => {
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[dayIdx] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[actIdx] };
        const newItems = [...newActivity.items];
        newItems.push({ text: 'ÈªûÊìäÁ∑®ËºØÊñ∞È†ÖÁõÆ', checked: false });
        newActivity.items = newItems;
        newActivities[actIdx] = newActivity;
        newDay.activities = newActivities;
        newItinerary[dayIdx] = newDay;
        setItinerary(newItinerary);
      };

      const deleteChecklistItem = (dayIdx, actIdx, itemIdx) => {
        if (!confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§È†ÖÁõÆÔºü')) return;
        const newItinerary = [...itinerary];
        const newDay = { ...newItinerary[dayIdx] };
        const newActivities = [...newDay.activities];
        const newActivity = { ...newActivities[actIdx] };
        const newItems = [...newActivity.items];
        newItems.splice(itemIdx, 1);
        newActivity.items = newItems;
        newActivities[actIdx] = newActivity;
        newDay.activities = newActivities;
        newItinerary[dayIdx] = newDay;
        setItinerary(newItinerary);
      };

      const currentDay = itinerary[activeDay];

      return (
        <div className="min-h-screen bg-[#fdf8f9] font-sans pb-20 relative">
          <header className="sticky top-0 z-40 bg-[#fdf8f9]/90 backdrop-blur-lg border-b border-rose-100 shadow-sm">
            <div className="max-w-3xl mx-auto px-4 pt-3 pb-0"> 
              <div className="flex flex-row justify-between items-start gap-2 mb-1">
                <div className="flex flex-col items-start gap-1 min-w-0">
                  <h1 className="text-xl md:text-3xl font-bold text-rose-950 tracking-tight truncate w-full">{UI_LABELS[lang].title}</h1>
                  {UI_LABELS[lang].subtitle && <span className="text-xs md:text-sm text-rose-700/70 truncate w-full">{UI_LABELS[lang].subtitle}</span>}
                  <RealTimeDateDisplay />
                </div>
                <div className="flex flex-col items-end gap-2 shrink-0">
                   <TimeWeatherWidget />
                   <div className="flex items-center gap-2">
                     <button onClick={() => setShowSettings(true)} className="p-1.5 bg-stone-100 text-stone-600 rounded-full hover:bg-stone-200 transition-colors"><Settings size={16} /></button>
                     <button onClick={() => setShowSplitBill(true)} className="p-1.5 bg-emerald-100 text-emerald-600 rounded-full hover:bg-emerald-200 transition-colors"><Banknote size={16} /></button>
                     <div className="flex bg-rose-100/50 p-1 rounded-full">{Object.keys(LANGUAGES).map(l => <button key={l} onClick={() => handleLangChange(l)} className={`px-2 py-1 rounded-full text-[10px] font-bold transition-all ${lang === l ? 'bg-white text-rose-600 shadow-sm' : 'text-rose-400'}`}>{l}</button>)}</div>
                   </div>
                </div>
              </div>
            </div>
            <div className="max-w-3xl mx-auto px-2 overflow-x-auto no-scrollbar pb-2">
              <div className="flex space-x-2 py-2 min-w-max">
                {itinerary.map((day, idx) => (
                  <button key={idx} onClick={() => setActiveDay(idx)} className={`flex flex-col items-center min-w-[4rem] py-2 px-2 rounded-2xl border transition-all ${activeDay === idx ? 'bg-rose-400 border-rose-400 text-white shadow-md scale-105' : 'bg-white border-rose-100 text-stone-400'}`}>
                    <span className="text-[10px] font-bold opacity-80">{UI_LABELS[lang].days[idx]}</span>
                    <span className="text-sm font-bold mt-0.5">{day.date.split(' ')[0]}</span>
                  </button>
                ))}
              </div>
            </div>
          </header>
          <main className="max-w-3xl mx-auto px-4 py-4 pb-20 relative min-h-[60vh]" onTouchStart={onTouchStart} onTouchEnd={onTouchEnd}>
            <div key={activeDay} className="animate-fade-in">
              <div className="mb-6 pl-2 border-l-4 border-rose-300 flex justify-between items-center">
                <div>
                  <div className="text-stone-400 text-sm font-medium mb-0.5">{currentDay.date}</div>
                  <h2 className="text-xl font-bold text-stone-800"><EditableText text={currentDay.theme} onSave={(v) => updateTheme(activeDay, v)} /></h2>
                </div>
                <div className="flex gap-2">
                  <button onClick={forceSave} className="flex items-center gap-1 text-xs font-bold text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-full shadow-sm hover:bg-emerald-100 transition-colors shrink-0"><Save size={14} /><span>ÂÑ≤Â≠ò</span></button>
                  {activeDay !== 0 && activeDay !== 1 && activeDay !== 7 && (
                    <button onClick={() => setShowAddEventModal(true)} className="flex items-center gap-1 text-xs font-bold text-white bg-rose-400 px-3 py-1.5 rounded-full shadow-sm hover:bg-rose-500 transition-colors shrink-0"><Plus size={14} /><span>{UI_LABELS[lang].addEvent}</span></button>
                  )}
                </div>
              </div>
              <div className="space-y-4">
                {currentDay.activities.map((item, i) => (
                  <div key={i} className="relative group">
                    <div className={`bg-white rounded-2xl p-4 shadow-sm border hover:shadow-md transition-shadow ${item.type.includes('warning') ? 'border-amber-200 bg-amber-50/30' : (item.type === 'checklist' ? 'border-emerald-100' : (item.type === 'ses' ? 'border-blue-200 bg-blue-50/30' : 'border-stone-100'))}`}>
                      {item.type === 'checklist' || item.type.includes('warning') || item.type === 'doc' || item.type === 'ses' ? (
                        <div>
                           <div className="flex items-center gap-2 mb-2">
                              <h3 className={`font-bold text-lg ${item.type.includes('warning') ? 'text-amber-700' : (item.type === 'ses' ? 'text-blue-800' : 'text-stone-800')}`}>{item.title}</h3>
                           </div>
                           <p className="text-sm text-stone-500 mb-3">{item.desc}</p>
                           <ul className="space-y-2">
                             {item.items && item.items.map((subItem, subIdx) => (
                               <li key={subIdx} className="flex items-start gap-2 text-sm text-stone-700 group/item">
                                  {item.type !== 'ses' && (
                                    <input 
                                      type="checkbox" 
                                      checked={subItem.checked || false}
                                      onChange={() => toggleCheck(activeDay, i, subIdx)}
                                      className={`mt-1 w-4 h-4 rounded border-gray-300 focus:ring-rose-400 cursor-pointer ${item.type.includes('warning') ? 'accent-amber-500' : 'accent-emerald-500'}`} 
                                    />
                                  )}
                                  <span className={`flex-1 break-words ${item.type === 'ses' ? 'text-blue-700 font-medium' : (subItem.checked ? 'line-through text-stone-400' : '')}`}>
                                    {item.type === 'ses' ? subItem.text : (
                                      <EditableText 
                                        text={subItem.text} 
                                        onSave={(val) => updateChecklistItemText(activeDay, i, subIdx, val)} 
                                        className="w-full"
                                      />
                                    )}
                                  </span>
                                  {item.type !== 'ses' && (
                                    <button 
                                      onClick={() => deleteChecklistItem(activeDay, i, subIdx)}
                                      className="opacity-0 group-hover/item:opacity-100 text-stone-400 hover:text-red-400 transition-opacity"
                                    >
                                      <Trash2 size={14} />
                                    </button>
                                  )}
                               </li>
                             ))}
                           </ul>
                           {item.type !== 'ses' && (
                             <button 
                               onClick={() => addChecklistItem(activeDay, i)}
                               className="mt-3 text-xs flex items-center gap-1 text-stone-400 hover:text-rose-500 transition-colors"
                             >
                               <Plus size={12} /> {UI_LABELS[lang].addItem}
                             </button>
                           )}
                        </div>
                      ) : (
                        <div>
                          <div className="flex justify-between items-center mb-2 pb-2 border-b border-stone-50">
                            <div className="flex items-center gap-2 overflow-hidden">
                               <div className="bg-rose-100 text-rose-500 rounded-full p-1 shrink-0">
                                 <IconType type={item.type} className="w-3 h-3" />
                               </div>
                               <span className="font-mono text-rose-500 font-bold bg-rose-50 px-1.5 rounded text-sm shrink-0"><EditableText text={item.time} onSave={(v) => updateActivity(activeDay, i, 'time', v)} /></span>
                               <h3 className="font-bold text-stone-800 truncate"><EditableText text={item.title} onSave={(v) => updateActivity(activeDay, i, 'title', v)} /></h3>
                            </div>
                            <ActivityWeather day={activeDay} index={i} location={item.location} />
                          </div>
                          <div className="text-stone-600 text-sm mb-3 leading-relaxed"><EditableText multiline text={item.desc} onSave={(v) => updateActivity(activeDay, i, 'desc', v)} /></div>
                          <button onClick={() => setSelectedActivity(item)} className="flex items-center gap-1 text-[10px] font-bold text-rose-500 bg-rose-50 px-2 py-1 rounded hover:bg-rose-100 transition-colors w-fit mb-2"><Sparkles size={10} />{UI_LABELS[lang].genPhrases}</button>
                          {(item.location || item.transport || item.duration) && (
                            <div className="mt-2 flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-stone-500">
                              {item.location && (
                                <a 
                                  href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`} 
                                  target="_blank" 
                                  rel="noopener noreferrer"
                                  className="flex items-center gap-1 text-rose-400 hover:text-rose-600 transition-colors group/map shrink-0"
                                  onClick={(e) => e.stopPropagation()}
                                >
                                  <MapPin size={11} className="group-hover/map:scale-110 transition-transform" />
                                  <span className="border-b border-transparent group-hover/map:border-rose-400">{item.location}</span>
                                </a>
                              )}
                              {item.transport && <TransportDisplay text={item.transport} />}
                            </div>
                          )}
                        </div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </main>
          <AIChatWidget itinerary={itinerary} lang={lang} />
          {selectedActivity && <MagicPhraseModal activity={selectedActivity} lang={lang} onClose={() => setSelectedActivity(null)} />}
          {showAddEventModal && <AddEventModal onClose={() => setShowAddEventModal(false)} onSave={handleSaveNewEvent} lang={lang} />}
          {showSplitBill && <SplitBillModal onClose={() => setShowSplitBill(false)} lang={lang} />}
          {showSettings && <SettingsModal onClose={() => setShowSettings(false)} lang={lang} />}
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
